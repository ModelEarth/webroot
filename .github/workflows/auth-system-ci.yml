name: Auth System CI/CD

on:
  push:
    branches: [ main ]
    paths:
      - 'auth-system/**'
      - '.github/workflows/auth-system-ci.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'auth-system/**'
      - '.github/workflows/auth-system-ci.yml'

jobs:
  test:
    name: Test Auth System
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./auth-system

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: auth-system/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Create test environment
        run: |
          cp .env.example .env
          sed -i 's/your-secret-key-for-jwt-signing-min-32-characters/test-jwt-secret-key-for-ci-testing-32-chars-minimum/g' .env
          cat .env

      - name: Run configuration debug
        run: npm run debug
        continue-on-error: true

      - name: Test service starts
        run: |
          npm start &
          SERVER_PID=$!
          echo "Server PID: $SERVER_PID"

          # Wait for server to start
          for i in {1..30}; do
            if curl -f http://localhost:3001/health 2>/dev/null; then
              echo "Server started successfully"
              kill $SERVER_PID
              exit 0
            fi
            echo "Waiting for server... attempt $i/30"
            sleep 2
          done

          echo "Server failed to start"
          kill $SERVER_PID 2>/dev/null || true
          exit 1

      - name: Verify health endpoint
        run: |
          npm start &
          SERVER_PID=$!
          sleep 5

          HEALTH_RESPONSE=$(curl -s http://localhost:3001/health)
          echo "Health response: $HEALTH_RESPONSE"

          if echo "$HEALTH_RESPONSE" | grep -q "\"status\":\"ok\""; then
            echo "✅ Health check passed"
            kill $SERVER_PID
            exit 0
          else
            echo "❌ Health check failed"
            kill $SERVER_PID
            exit 1
          fi

  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          cd auth-system
          docker build -t auth-system:${{ github.sha }} .
          docker tag auth-system:${{ github.sha }} auth-system:latest

      - name: Test Docker container
        run: |
          docker run -d -p 3001:3001 \
            -e JWT_SECRET=test-jwt-secret-key-for-ci-testing-32-chars-minimum \
            -e PORT=3001 \
            -e BASE_URL=http://localhost:3001 \
            -e FRONTEND_URL=http://localhost:8887 \
            --name auth-test \
            auth-system:latest

          # Wait for container to be healthy
          for i in {1..30}; do
            if docker exec auth-test curl -f http://localhost:3001/health 2>/dev/null; then
              echo "✅ Docker container is healthy"
              docker stop auth-test
              docker rm auth-test
              exit 0
            fi
            echo "Waiting for container... attempt $i/30"
            sleep 2
          done

          echo "❌ Docker container health check failed"
          docker logs auth-test
          docker stop auth-test
          docker rm auth-test
          exit 1

      - name: Save Docker image as artifact
        if: success()
        run: |
          docker save auth-system:latest | gzip > auth-system-image.tar.gz

      - name: Upload Docker image
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: auth-system-docker-image
          path: auth-system-image.tar.gz
          retention-days: 7

  lint:
    name: Code Quality Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./auth-system

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Check for syntax errors
        run: |
          for file in src/*.js; do
            echo "Checking $file..."
            node -c "$file"
          done

      - name: Check file structure
        run: |
          echo "Verifying required files exist..."
          test -f package.json || exit 1
          test -f src/index.js || exit 1
          test -f src/jwt.js || exit 1
          test -f src/oauth.js || exit 1
          test -f src/oauth-providers.js || exit 1
          test -f public/auth-client.js || exit 1
          test -f .env.example || exit 1
          test -f README.md || exit 1
          test -f Dockerfile || exit 1
          echo "✅ All required files present"
