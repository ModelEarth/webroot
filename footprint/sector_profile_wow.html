<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8'>
  <title>Sector Analysis - Environmental profile</title>
  <link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://unpkg.com/tabulator-tables@5.2.7/dist/css/tabulator.min.css" rel="stylesheet">
  <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.2.7/dist/js/tabulator.min.js"></script>

  <script type="text/javascript" src="/localsite/js/localsite.js?showheader=true&showsearch=true"></script>
  <script src="js/useeio.js"></script>
</head>

<body>

<div class="content contentpadding">
  <div style="margin-bottom:10px">
    <a id="footprintLink" href="../state/" >State Impact Reports</a> - 
    <a id="commoditiesLink" href="commodities.html">Commodities</a>
  </div>
  <div id="relocatedStateMenu"></div>
  
  <p id="info">Loading ...</p>
  <div id="table"></div>
  
  <!-- Matrix and Data Sources Section -->
  <div id="matrixSection" style="margin-top: 40px; display: none;">
    <h3>Technical Coefficient Matrix</h3>
    <p id="matrixInfo">Loading matrix data...</p>
    <div id="matrixTable"></div>
  </div>
  
  <div id="dataSourcesSection" style="margin-top: 40px; display: none;">
    <h3>Data Sources</h3>
    <p id="dataSourcesInfo">Loading data sources...</p>
    <div id="dataSourcesTable"></div>
  </div>
</div>

<script src="js/config.js"></script>
<script>
document.addEventListener('hashChangeEvent', hashChangedUseeio, false);
function hashChangedUseeio() {
  console.log("URL hash changed");
  model = getModel();
  updateHash({"demand":""});
  main();
}

function norm100(nums) {
  let max = 0;
  for (const num of nums) {
    max = Math.max(Math.abs(num), max);
  }
  if (max === 0) {
    return nums;
  }
  const norm = [];
  for (const num of nums) {
    norm.push(100 * num / max)
  }
  return norm;
}

async function getRandomSector() {
  const sectors = await model.sectors();
  return sectors[Math.floor(Math.random() * sectors.length)];
}

async function main() {
  let hash = getHash();
  if (hash.state) {
    // Append to links at top of page.
    document.getElementById('footprintLink').setAttribute('href', '../#state=' + hash.state);
    document.getElementById('commoditiesLink').setAttribute('href', 'commodities.html#state=' + hash.state);
  }
  const info = document.getElementById("info");
  
  // Parse URL parameters
  //const fullhash = window.location.hash;
  //const params = new URLSearchParams(fullhash.substring(1));
  
  let sector;
  const sectors = await model.sectors();

  // loading random sector profile report if no hash
  if (!hash.demand) {
    sector = await getRandomSector();
    // update URL with random sector's hash
    hash.demand = `${sector.code}/${sector.location}`;
    updateHash({"demand":hash.demand});
  }
  
  // Handle demand parameter (new format)
  if (hash.demand) {
    const [code, location] = hash.demand.split("/");
    sector = sectors.find(s => s.code === code && s.location === location);
  }
  // Handle index parameter (legacy format)
  else if (hash.index) {
    const sectorIndex = parseInt(hash.index);
    sector = sectors.find(s => s.index === sectorIndex);
  }
  // Handle legacy industry parameter
  else if (hash.industry) {
    const sectorIndex = parseInt(hash.industry);
    sector = sectors.find(s => s.index === sectorIndex);
  }
  
  /*
  let stateCode;
  if (hash.state) {
    stateCode = hash.state;
  } else 

  if (hash.demand) {
    const [code, location] = hash.demand.split('/');
    if (!location) {
      info.textContent = "No location value in demand: " + hash.demand;
      document.getElementById('table').innerHTML = "";
      return;
    } else if (location.includes('/')) {
      stateCode = location.split('/')[1];
    }
  }
  */

  if (!sector) {
    info.textContent = "No valid sector specified in the URL.";
    if (hash.state) {
      info.textContent = `No valid sector specified in the URL in ${hash.state} model.`;
    }
    document.getElementById('table').innerHTML = "";
    return;
  }

  const demandId = await model.findDemand({
    system: "Complete",
    type: "Consumption",
  });
  if (!demandId) {
    info.textContent = "Failed to load demand";
    document.getElementById('table').innerHTML = "";
    return;
  }
  
  info.textContent = `Analyzing sector '${sector.name}' based on ${demandId}`;

  const analysis = await useeio.SectorAnalysis.of(model, sector, demandId);
  const indicators = await model.indicators();
  const direct = norm100(await analysis.getEnvironmentalProfile(true));
  const total = norm100(await analysis.getEnvironmentalProfile(false));
  const results = indicators.map(i => {
    return {
      indicator: `${i.code} - ${i.name}`,
      direct: direct[i.index],
      total: total[i.index],
    }
  });

  info.innerHTML = `<h3 style="font-size:22px">${sector.name}</h3>Environmental profile of based on ${demandId} for <b>${sector.id}</b>`;
  new Tabulator("#table", {
    data: results,
    layout: "fitColumns",
    columns: [
      { title: "Indicator", field: "indicator" },
      { title: "Direct", field: "direct", formatter: "progress", sorter: "number", headerSortTristate: false, headerSortStartingDir: "desc" },
      { title: "Total", field: "total", formatter: "progress", sorter: "number" },
    ],
    initialSort: [
      { column: "total", dir: "desc" },
    ]
  });

  // Load and display matrix and data sources
  await loadMatrixData(sector, analysis);
  await loadDataSources(sector);
}

async function loadMatrixData(sector, analysis) {
  try {
    const matrixSection = document.getElementById('matrixSection');
    const matrixInfo = document.getElementById('matrixInfo');
    const matrixTable = document.getElementById('matrixTable');
    
    // Get model information for data source URL
    const modelName = getModelFolderName();
    const dataSourceUrl = `https://raw.githubusercontent.com/ModelEarth/useeio-json/main/models/2020/${modelName}/A.json`;
    
    matrixInfo.innerHTML = `Technical coefficients for sector: <strong>${sector.name}</strong><br>
      <small>Data source: <a href="${dataSourceUrl}" target="_blank">A Matrix (${modelName})</a></small>`;
    
    // Get matrix data from the model
    const sectors = await model.sectors();
    const matrixA = await model.matrix('A'); // Technical coefficient matrix
    
    if (matrixA && matrixA.data && matrixA.data.length > 0) {
      // Get the row for the current sector - matrixA.data is the actual 2D array
      const sectorRow = matrixA.data[sector.index] || [];
      
      // Create data for the top contributing sectors
      const matrixData = sectors
        .map((s, index) => ({
          sector: s.name,
          coefficient: sectorRow[index] || 0,
          sectorCode: s.code,
          sectorId: s.id
        }))
        .filter(item => Math.abs(item.coefficient) > 0.0001) // Filter out very small values
        .sort((a, b) => Math.abs(b.coefficient) - Math.abs(a.coefficient))
        .slice(0, 25); // Show top 25 contributors
      
      if (matrixData.length > 0) {
        // Create Tabulator table for matrix data
        new Tabulator("#matrixTable", {
          data: matrixData,
          layout: "fitColumns",
          height: "400px",
          columns: [
            { title: "Sector Name", field: "sector", width: 250 },
            { title: "Code", field: "sectorCode", width: 80 },
            { title: "Sector ID", field: "sectorId", width: 120 },
            { 
              title: "Technical Coefficient", 
              field: "coefficient", 
              formatter: function(cell) {
                const val = cell.getValue();
                return val.toExponential(4);
              },
              sorter: "number",
              width: 150
            }
          ],
          initialSort: [
            { column: "coefficient", dir: "desc" }
          ]
        });
      } else {
        matrixTable.innerHTML = '<p>No significant technical coefficients found for this sector.</p>';
      }
      
      matrixSection.style.display = 'block';
    } else {
      // Try alternative access method
      const matrixCol = await model.matrixColumn('A', sector.index);
      if (matrixCol && matrixCol.length > 0) {
        const matrixData = sectors
          .map((s, index) => ({
            sector: s.name,
            coefficient: matrixCol[index] || 0,
            sectorCode: s.code,
            sectorId: s.id
          }))
          .filter(item => Math.abs(item.coefficient) > 0.0001)
          .sort((a, b) => Math.abs(b.coefficient) - Math.abs(a.coefficient))
          .slice(0, 25);
        
        if (matrixData.length > 0) {
          new Tabulator("#matrixTable", {
            data: matrixData,
            layout: "fitColumns",
            height: "400px",
            columns: [
              { title: "Sector Name", field: "sector", width: 250 },
              { title: "Code", field: "sectorCode", width: 80 },
              { title: "Sector ID", field: "sectorId", width: 120 },
              { 
                title: "Technical Coefficient", 
                field: "coefficient", 
                formatter: function(cell) {
                  const val = cell.getValue();
                  return val.toExponential(4);
                },
                sorter: "number",
                width: 150
              }
            ],
            initialSort: [
              { column: "coefficient", dir: "desc" }
            ]
          });
        } else {
          matrixTable.innerHTML = '<p>No significant technical coefficients found for this sector.</p>';
        }
        matrixSection.style.display = 'block';
      } else {
        matrixInfo.innerHTML += '<br><em>Matrix data not available for this sector.</em>';
        matrixSection.style.display = 'block';
      }
    }
  } catch (error) {
    console.error('Error loading matrix data:', error);
    document.getElementById('matrixInfo').innerHTML = `Technical coefficients for sector: <strong>${sector.name}</strong><br><em>Error loading matrix data: ${error.message}</em>`;
    document.getElementById('matrixSection').style.display = 'block';
  }
}

async function loadDataSources(sector) {
  try {
    const dataSourcesSection = document.getElementById('dataSourcesSection');
    const dataSourcesInfo = document.getElementById('dataSourcesInfo');
    const dataSourcesTable = document.getElementById('dataSourcesTable');
    
    // Get model information
    const modelName = getModelFolderName();
    const baseUrl = `https://raw.githubusercontent.com/ModelEarth/useeio-json/main/models/2020/${modelName}`;
    
    dataSourcesInfo.innerHTML = `Data sources and methodology for sector: <strong>${sector.name}</strong> (${modelName})`;
    
    // Get model metadata
    let metadata;
    try {
      metadata = await model.metadata();
    } catch (e) {
      console.warn('Could not load metadata:', e);
      metadata = { version: modelName };
    }
    
    // Get indicators and demands to show what data is actually used
    const indicators = await model.indicators();
    const demands = await model.demands();
    
    // Create comprehensive data sources information
    const dataSourcesData = [
      {
        dataset: "Technical Coefficient Matrix (A)",
        description: "Inter-industry economic relationships and dependencies",
        format: "JSON Matrix",
        url: `${baseUrl}/A.json`,
        usage: "Calculates direct economic impacts between sectors"
      },
      {
        dataset: "Environmental Matrix (B)",
        description: "Direct environmental coefficients by sector",
        format: "JSON Matrix", 
        url: `${baseUrl}/B.json`,
        usage: "Direct environmental impacts per dollar of output"
      },
      {
        dataset: "Total Requirements Matrix (L)",
        description: "Leontief inverse matrix (I-A)^-1",
        format: "JSON Matrix",
        url: `${baseUrl}/L.json`, 
        usage: "Calculates total economic requirements (direct + indirect)"
      },
      {
        dataset: "Environmental Multipliers (D)",
        description: "Total environmental impact coefficients",
        format: "JSON Matrix",
        url: `${baseUrl}/D.json`,
        usage: "Total environmental impacts (direct + indirect + induced)"
      },
      {
        dataset: "Sectors",
        description: `${sector.code} - ${sector.name} and all other sectors`,
        format: "JSON Array",
        url: `${baseUrl}/sectors.json`,
        usage: "Sector classification and naming"
      },
      {
        dataset: "Indicators", 
        description: `${indicators.length} environmental impact indicators`,
        format: "JSON Array",
        url: `${baseUrl}/indicators.json`,
        usage: "Environmental impact categories (GHG, water, land, etc.)"
      },
      {
        dataset: "Demands",
        description: `${demands.length} demand vectors available`,
        format: "JSON Object",
        url: `${baseUrl}/demands.json`, 
        usage: "Economic demand scenarios for analysis"
      }
    ];
    
    // Add location-specific information if available
    if (sector.location && sector.location !== 'US') {
      dataSourcesData.push({
        dataset: "State-Level Data",
        description: `Location-specific data for ${sector.location}`,
        format: "Model Extension",
        url: "https://www.epa.gov/land-research/useeio-state-models",
        usage: "State-level economic and environmental coefficients"
      });
    }
    
    // Add metadata information
    dataSourcesData.push({
      dataset: "Model Metadata",
      description: `${metadata?.name || modelName} model information`,
      format: "JSON Object", 
      url: `${baseUrl}/metadata.json`,
      usage: "Model version, description, and technical specifications"
    });
    
    // Create Tabulator table for data sources
    new Tabulator("#dataSourcesTable", {
      data: dataSourcesData,
      layout: "fitColumns",
      height: "400px",
      columns: [
        { title: "Dataset", field: "dataset", width: 180 },
        { title: "Description", field: "description", width: 250 },
        { title: "Usage in Report", field: "usage", width: 200 },
        { title: "Format", field: "format", width: 100 },
        { 
          title: "Data Link", 
          field: "url", 
          formatter: function(cell) {
            const url = cell.getValue();
            const filename = url.split('/').pop();
            return `<a href="${url}" target="_blank">${filename}</a>`;
          },
          width: 120
        }
      ]
    });
    
    dataSourcesSection.style.display = 'block';
  } catch (error) {
    console.error('Error loading data sources:', error);
    document.getElementById('dataSourcesInfo').innerHTML = `Data sources and methodology for sector: <strong>${sector?.name || 'Unknown'}</strong><br><em>Error: ${error.message}</em>`;
    document.getElementById('dataSourcesSection').style.display = 'block';
  }
}
main();
</script>

</body>
</html>