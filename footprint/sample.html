<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Environmental Footprint Chart</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon">
    
    <!-- Shared CSS from localsite -->
    <script type="text/javascript" src="../../localsite/js/localsite.js?showheader=true&showsearch=false"></script>
    <link type="text/css" rel="stylesheet" href="../../localsite/css/base.css" id="/localsite/css/base.css"/>
    <link type="text/css" rel="stylesheet" href="../../localsite/css/base-tabulator.css" id="/localsite/css/base-tabulator.css"/>
    
    <!-- Tabulator CSS -->
    <link href="https://unpkg.com/tabulator-tables@5.2.7/dist/css/tabulator.min.css" rel="stylesheet">
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        .toggle-data-container {
            margin: 20px 0;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 5px;
            text-align: center;
        }
        
        .toggle-data-container label {
            margin: 0 15px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .toggle-data-container input[type="radio"] {
            margin-right: 5px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #666;
        }
        
        .data-info {
            margin: 15px 0;
            padding: 10px;
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            border-radius: 3px;
        }
        
        .totals {
            margin: 15px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }
        
        .totals h3 {
            margin-top: 0;
            color: #495057;
        }
        
        #table {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .data-sources {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            font-family: monospace;
        }
        
        .data-sources h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #495057;
            font-family: inherit;
        }
        
        .data-path {
            background-color: #e9ecef;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 3px;
            font-size: 0.9em;
            word-break: break-all;
            border-left: 4px solid #007bff;
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .data-path:hover {
            background-color: #dee2e6;
        }
        
        .data-path.exiobase {
            border-left-color: #28a745;
        }
        
        .data-path.fallback {
            border-left-color: #ffc107;
            background-color: #fff3cd;
        }
        
        .data-path.useeio-file {
            border-left-color: #17a2b8;
            background-color: #efefef;
            margin-left: 20px;
            font-size: 0.85em;
        }
        
        .data-path-label {
            font-weight: bold;
            color: #495057;
            margin-right: 8px;
        }
        
        .expand-arrow {
            display: inline-block;
            margin-right: 8px;
            color: #6c757d;
            cursor: pointer;
            font-size: 1.2em;
            transition: transform 0.2s ease, color 0.2s;
            vertical-align: middle;
        }
        
        .expand-arrow:hover {
            color: #495057;
        }
        
        .expand-arrow.expanded {
            transform: rotate(90deg);
        }
        
        .data-path.parent-row {
            cursor: pointer;
        }
        
        .data-path.child-row {
            margin-left: 30px;
            border-left-color: #6c757d;
            background-color: #f8f9fa;
        }
        
        .data-path.child-row.hidden {
            display: none;
        }
        
        .data-path-menu {
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 10;
        }
        
        .menu-trigger {
            display: inline-block;
            padding: 4px;
            color: #6c757d;
            cursor: pointer;
            font-size: 1.8em;
            transition: color 0.2s;
            border-radius: 3px;
        }
        
        .menu-trigger:hover {
            color: #495057;
            background-color: rgba(0,0,0,0.1);
        }
        
        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-width: 150px;
            z-index: 1000;
            display: none;
        }
        
        .dropdown-menu.show {
            display: block;
        }
        
        .dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 0.9em;
            color: #495057;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .dropdown-item i {
            font-size: 1.6em;
        }
        
        .dropdown-item:hover {
            background-color: #f8f9fa;
        }
        
        .dropdown-item:first-child {
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
        }
        
        .dropdown-item:last-child {
            border-bottom-left-radius: 5px;
            border-bottom-right-radius: 5px;
        }
        
        .dropdown-divider {
            height: 1px;
            background-color: #dee2e6;
            margin: 4px 0;
        }
        
        .csv-viewer-container {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            display: none;
        }
        
        .csv-viewer-table {
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            max-height: 400px;
            overflow: auto;
        }
        
        .csv-viewer-table .tabulator-paginator .tabulator-page-size::after,
        #table .tabulator-paginator .tabulator-page-size::after {
            display: none !important;
        }
        
        .csv-viewer-table .tabulator-page-size,
        #table .tabulator-page-size {
            background: none !important;
        }
        
        .csv-viewer-table .tabulator-page-size select,
        #table .tabulator-page-size select {
            background: none !important;
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            appearance: none !important;
        }
    </style>
</head>

<body>
    <div class="content contentpadding" style="position: relative;">

        <div style="position:absolute; z-index:2; right:40px; top:42px">
          <a href="https://github.com/ModelEarth/MaterialScience/"><img src="../../localsite/img/icon/github/github.png" style="width:40px"></a>
        </div>

        <h1>Environmental Footprint Analysis</h1>
        <p>Toggle between US state-level data and international trade data to compare environmental and economic impacts.</p>
        
        <!-- Data Source Toggle -->
        <div class="toggle-data-container">
            <label>
                <input type="radio" name="dataSource" value="international" checked> Countries
            </label>
            <label>
                <input type="radio" name="dataSource" value="us"> US States
            </label>
            <label>
                <input type="radio" name="dataSource" value="combined"> Combined
            </label>
        </div>
        
        <!-- Data Information Display -->
        <div id="dataInfo" class="data-info">
            <strong>Current Data:</strong> <span id="dataDescription">US state-level economic output and employment data</span>
        </div>
        
        <!-- Totals Summary -->
        <div id="totalsContainer" class="totals">
            <h3>Summary Totals</h3>
            <div id="totalsContent">
                <div id="loadingTotals" class="loading">Loading totals...</div>
                <div id="totalsDisplay" style="display: none;">
                    <strong>Total Output:</strong> <span id="totalOutput">$0</span><br>
                    <strong>Total Employment:</strong> <span id="totalEmployment">0</span><br>
                    <strong>Regions/Countries:</strong> <span id="totalRegions">0</span>
                </div>
            </div>
        </div>
        
        <!-- Main Data Table -->
        <div id="loadingMessage" class="loading">Loading data...</div>
        <div id="table"></div>

        <!-- Data Sources Display -->
        <div id="dataSourcesContainer" class="data-sources" style="display: none;">
            <h3>Data Sources</h3>
            <div id="dataSourcesPaths"></div>
        </div>

        <br>
        <a href="../../useeio.js/footprint/">State Reports</a>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://unpkg.com/tabulator-tables@5.2.7/dist/js/tabulator.min.js"></script>
    <script src="../../localsite/js/localsite.js"></script>
    <script src="../../useeio.js/dist/useeio.js"></script>
    <script src="../../useeio.js/footprint/config.js"></script>
    
    <script>
        // Global variables
        let currentTable = null;
        let currentDataSource = 'international';
        let usStateData = [];
        let internationalData = [];
        let combinedData = [];
        
        // Country code to name mapping for international data
        const countryNames = {
            'US': 'United States',
            'CN': 'China',
            'DE': 'Germany',
            'FR': 'France', 
            'GB': 'United Kingdom',
            'IN': 'India',
            'JP': 'Japan',
            'IT': 'Italy',
            'BR': 'Brazil',
            'CA': 'Canada',
            'RU': 'Russia',
            'MX': 'Mexico',
            'KR': 'South Korea',
            'AU': 'Australia',
            'ES': 'Spain',
            'NL': 'Netherlands'
        };
        
        // State mapping - All 50 US states
        const stateMapping = {
            'AK': 'Alaska',
            'AL': 'Alabama',
            'AR': 'Arkansas',
            'AZ': 'Arizona',
            'CA': 'California',
            'CO': 'Colorado',
            'CT': 'Connecticut',
            'DE': 'Delaware',
            'FL': 'Florida',
            'GA': 'Georgia',
            'HI': 'Hawaii',
            'IA': 'Iowa',
            'ID': 'Idaho',
            'IL': 'Illinois',
            'IN': 'Indiana',
            'KS': 'Kansas',
            'KY': 'Kentucky',
            'LA': 'Louisiana',
            'MA': 'Massachusetts',
            'MD': 'Maryland',
            'ME': 'Maine',
            'MI': 'Michigan',
            'MN': 'Minnesota',
            'MO': 'Missouri',
            'MS': 'Mississippi',
            'MT': 'Montana',
            'NC': 'North Carolina',
            'ND': 'North Dakota',
            'NE': 'Nebraska',
            'NH': 'New Hampshire',
            'NJ': 'New Jersey',
            'NM': 'New Mexico',
            'NV': 'Nevada',
            'NY': 'New York',
            'OH': 'Ohio',
            'OK': 'Oklahoma',
            'OR': 'Oregon',
            'PA': 'Pennsylvania',
            'RI': 'Rhode Island',
            'SC': 'South Carolina',
            'SD': 'South Dakota',
            'TN': 'Tennessee',
            'TX': 'Texas',
            'UT': 'Utah',
            'VA': 'Virginia',
            'VT': 'Vermont',
            'WA': 'Washington',
            'WI': 'Wisconsin',
            'WV': 'West Virginia',
            'WY': 'Wyoming'
        };
        
        // Available countries in Exiobase data
        const exiobaseCountries = ['US', 'CN', 'DE', 'JP', 'GB', 'CA', 'AU', 'IT', 'KR', 'FR', 'BR', 'IN'];
        
        // Utility functions
        function formatNumber(num) {
            if (num >= 1e9) {
                return (num / 1e9).toFixed(1) + 'B';
            } else if (num >= 1e6) {
                return (num / 1e6).toFixed(1) + 'M';
            } else if (num >= 1e3) {
                return (num / 1e3).toFixed(1) + 'K';
            }
            return num.toFixed(0);
        }
        
        function formatCurrency(num) {
            return '$' + formatNumber(num);
        }
        
        // Load US state data from USEEIO.js models
        async function loadUSStateData() {
            try {
                updateDataInfo('US state-level economic output and employment data from USEEIO models');
                
                // States to process (all 50 states with available USEEIO models)
                const statesToLoad = Object.keys(stateMapping); // All 50 states
                const batchSize = 5; // Process in batches to handle all 50 states efficiently
                usStateData = [];
                
                console.log('Loading US state data for:', statesToLoad);
                
                // Process states in batches (similar to useeio.js/footprint/states.html)
                for (let i = 0; i < statesToLoad.length; i += batchSize) {
                    const batch = statesToLoad.slice(i, i + batchSize);
                    console.log(`Processing batch ${Math.floor(i/batchSize) + 1}:`, batch);
                    
                    const results = await Promise.all(batch.map(state => loadStateData(state)));
                    const validResults = results.filter(result => result !== null);
                    usStateData.push(...validResults);
                    
                    // Small delay between batches
                    if (i + batchSize < statesToLoad.length) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }
                
                // Sort by output descending
                usStateData.sort((a, b) => b.output - a.output);
                
                // Update data sources display with actual paths and files used
                const statePaths = [];
                usStateData.forEach(stateData => {
                    if (stateData.stateAbbr) {
                        const modelDir = `/useeio-json/models/2020/${stateData.stateAbbr}EEIOv1.0-s-20/`;
                        statePaths.push({
                            label: `${stateData.stateName} (${stateData.stateAbbr}) - Model Directory`,
                            path: modelDir,
                            type: 'useeio',
                            isLink: true,
                            isParent: true,
                            stateId: stateData.stateAbbr
                        });
                        // Add links to specific files used
                        const keyFiles = ['sectors.json', 'indicators.json', 'matrix/q.json', 'matrix/D.json'];
                        keyFiles.forEach(file => {
                            statePaths.push({
                                label: `${file}`,
                                path: modelDir + file,
                                type: 'useeio-file',
                                isLink: true,
                                isChild: true,
                                parentId: stateData.stateAbbr
                            });
                        });
                    }
                });
                updateDataSources('us', statePaths);
                
                console.log('Successfully loaded US state data:', usStateData.length + ' states');
                return usStateData;
                
            } catch (error) {
                console.error('Error loading US state data:', error);
                // Fall back to simulated data if real data fails
                const fallbackData = await loadSimulatedUSStateData();
                
                // Update data sources for fallback
                const fallbackPaths = [{
                    label: 'US States (Simulated Data)',
                    path: 'Fallback data - USEEIO models unavailable',
                    type: 'fallback',
                    isLink: false
                }];
                updateDataSources('us', fallbackPaths);
                
                return fallbackData;
            }
        }
        
        // Load individual state data using USEEIO.js
        async function loadStateData(stateCode) {
            try {
                console.log(`Loading data for state: ${stateCode}`);
                
                const modelParams = {
                    endpoint: '../../useeio-json/models/2020',
                    asJsonFiles: true,
                    model: `${stateCode}EEIOv1.0-s-20`
                };
                
                const model = await useeio.modelOf(modelParams);
                if (!model) {
                    throw new Error(`Failed to get model for state ${stateCode}`);
                }
                
                // Get required data
                const sectors = await model.sectors();
                const qMatrix = await model.matrix("q"); // Output matrix
                const dMatrix = await model.matrix("D"); // Direct requirements matrix
                const indicators = await model.indicators();
                const jobs = indicators.find(i => i.code === "JOBS");
                
                if (!jobs) {
                    throw new Error("Could not find jobs indicator");
                }
                
                // Filter sectors for this state and calculate totals
                const stateSectors = sectors.filter(s => s.location === `US-${stateCode}`);
                let totalOutput = 0;
                let totalJobs = 0;
                
                stateSectors.forEach(sector => {
                    const output = qMatrix.get(sector.index, 0) || 0;
                    const jobsPerDollar = dMatrix.get(jobs.index, sector.index) || 0;
                    const jobCount = output * jobsPerDollar;
                    
                    totalOutput += output;
                    totalJobs += jobCount;
                });
                
                console.log(`State ${stateCode} data:`, { output: totalOutput, jobs: totalJobs });
                
                return {
                    state: stateCode,
                    stateName: stateMapping[stateCode],
                    stateAbbr: stateCode,
                    output: Math.round(totalOutput),
                    outputFormatted: formatCurrency(Math.round(totalOutput)),
                    employment: Math.round(totalJobs),
                    employmentFormatted: formatNumber(Math.round(totalJobs)),
                    type: 'state'
                };
                
            } catch (error) {
                console.error(`Error loading state ${stateCode}:`, error);
                return null;
            }
        }
        
        // Fallback simulated data if real data fails
        async function loadSimulatedUSStateData() {
            console.log('Falling back to simulated US state data');
            const simulatedData = [
                { state: 'CA', stateName: 'California', stateAbbr: 'CA', output: 2500000000000, employment: 18500000, type: 'state' },
                { state: 'TX', stateName: 'Texas', stateAbbr: 'TX', output: 1800000000000, employment: 13200000, type: 'state' },
                { state: 'NY', stateName: 'New York', stateAbbr: 'NY', output: 1600000000000, employment: 9500000, type: 'state' },
                { state: 'FL', stateName: 'Florida', stateAbbr: 'FL', output: 900000000000, employment: 9200000, type: 'state' },
                { state: 'IL', stateName: 'Illinois', stateAbbr: 'IL', output: 750000000000, employment: 6100000, type: 'state' },
                { state: 'PA', stateName: 'Pennsylvania', stateAbbr: 'PA', output: 720000000000, employment: 6000000, type: 'state' },
                { state: 'OH', stateName: 'Ohio', stateAbbr: 'OH', output: 650000000000, employment: 5400000, type: 'state' },
                { state: 'GA', stateName: 'Georgia', stateAbbr: 'GA', output: 520000000000, employment: 4700000, type: 'state' },
                { state: 'NC', stateName: 'North Carolina', stateAbbr: 'NC', output: 500000000000, employment: 4600000, type: 'state' },
                { state: 'NJ', stateName: 'New Jersey', stateAbbr: 'NJ', output: 580000000000, employment: 4200000, type: 'state' }
            ];
            
            // Add formatted values
            simulatedData.forEach(row => {
                row.outputFormatted = formatCurrency(row.output);
                row.employmentFormatted = formatNumber(row.employment);
            });
            
            return simulatedData;
        }
        
        // Load international data from Exiobase CSV files
        async function loadInternationalData() {
            try {
                updateDataInfo('International trade flow data from Exiobase MRIO database (2019)');
                
                // Check if we should include US data based on URL hash
                const hash = window.location.hash.substring(1);
                const shouldIncludeUS = hash.includes('country=US') || (!hash.includes('country=') && !hash.includes('state='));
                
                // Countries to process - include US if specifically requested
                const countriesToLoad = shouldIncludeUS ? 
                    exiobaseCountries : 
                    exiobaseCountries.filter(c => c !== 'US');
                internationalData = [];
                
                console.log('Loading international data for:', countriesToLoad);
                
                // Process countries in smaller batches
                const batchSize = 4;
                for (let i = 0; i < countriesToLoad.length; i += batchSize) {
                    const batch = countriesToLoad.slice(i, i + batchSize);
                    console.log(`Processing international batch ${Math.floor(i/batchSize) + 1}:`, batch);
                    
                    const results = await Promise.all(batch.map(country => loadCountryData(country)));
                    const validResults = results.filter(result => result !== null);
                    internationalData.push(...validResults);
                    
                    // Small delay between batches
                    if (i + batchSize < countriesToLoad.length) {
                        await new Promise(resolve => setTimeout(resolve, 200));
                    }
                }
                
                // Sort by output descending
                internationalData.sort((a, b) => b.output - a.output);
                
                // Update data sources display with actual paths used
                const countryPaths = [];
                internationalData.forEach(countryData => {
                    if (countryData.country) {
                        countryPaths.push({
                            label: `${countryData.countryName} (${countryData.country})`,
                            path: `../../exiobase/tradeflow/year/2019/${countryData.country}/domestic/trade_impacts.csv`,
                            type: 'exiobase',
                            isLink: true
                        });
                    }
                });
                updateDataSources('international', countryPaths);
                
                console.log('Successfully loaded international data:', internationalData.length + ' countries');
                return internationalData;
                
            } catch (error) {
                console.error('Error loading international data:', error);
                // Fall back to simulated data if real data fails
                const fallbackData = await loadSimulatedInternationalData();
                
                // Update data sources for fallback
                const fallbackPaths = [{
                    label: 'International (Simulated Data)',
                    path: 'Fallback data - Exiobase CSV files unavailable',
                    type: 'fallback',
                    isLink: false
                }];
                updateDataSources('international', fallbackPaths);
                
                return fallbackData;
            }
        }
        
        // Load individual country data from Exiobase CSV
        async function loadCountryData(countryCode) {
            try {
                console.log(`Loading data for country: ${countryCode}`);
                
                // Try to load the trade_impacts.csv file for this country
                const csvPath = `../../exiobase/tradeflow/year/2019/${countryCode}/domestic/trade_impacts.csv`;
                
                const response = await fetch(csvPath);
                if (!response.ok) {
                    throw new Error(`Failed to fetch CSV for country ${countryCode}: ${response.status}`);
                }
                
                const csvText = await response.text();
                const rows = parseCSV(csvText);
                
                if (rows.length === 0) {
                    throw new Error(`No data found for country ${countryCode}`);
                }
                
                // For US specifically, capture all available columns
                if (countryCode === 'US') {
                    console.log(`Available columns for ${countryCode}:`, Object.keys(rows[0] || {}));
                    console.log(`Sample row for ${countryCode}:`, rows[0]);
                }
                
                // Aggregate data by summing all trade flows
                let totals = {};
                let transactionCount = 0;
                
                rows.forEach(row => {
                    // Skip header row and invalid data
                    if (row.amount && !isNaN(parseFloat(row.amount))) {
                        // For each numeric column, add to totals
                        Object.keys(row).forEach(key => {
                            const value = parseFloat(row[key]);
                            if (!isNaN(value)) {
                                totals[key] = (totals[key] || 0) + value;
                            }
                        });
                        transactionCount++;
                    }
                });
                
                console.log(`Country ${countryCode} data totals:`, totals);
                
                // Create base result object
                const result = {
                    country: countryCode,
                    countryName: countryNames[countryCode] || countryCode,
                    output: Math.round(totals.amount || 0),
                    outputFormatted: formatCurrency(Math.round(totals.amount || 0)),
                    employment: Math.round(totals.Employment_total || 0),
                    employmentFormatted: formatNumber(Math.round(totals.Employment_total || 0)),
                    transactionCount: transactionCount,
                    type: 'country'
                };
                
                // Add key environmental metrics for all countries
                const keyMetrics = ['CO2_total', 'Energy_total', 'Water_total', 'Land_total', 'CH4_total', 'N2O_total', 'NOX_total'];
                keyMetrics.forEach(metric => {
                    if (totals[metric] !== undefined) {
                        result[metric] = Math.round(totals[metric] || 0);
                        result[metric + '_formatted'] = formatNumber(Math.round(totals[metric] || 0));
                    }
                });
                
                // For US, add all available data columns and mark for extended display
                if (countryCode === 'US') {
                    Object.keys(totals).forEach(key => {
                        if (!result[key] && key !== 'amount') {
                            result[key] = Math.round(totals[key] || 0);
                            result[key + '_formatted'] = formatNumber(Math.round(totals[key] || 0));
                        }
                    });
                    
                    // Store all columns for potential table display
                    result.allColumns = Object.keys(totals);
                    result.allData = totals;
                }
                
                return result;
                
            } catch (error) {
                console.error(`Error loading country ${countryCode}:`, error);
                return null;
            }
        }
        
        // Simple CSV parser for Exiobase data
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) return [];
            
            const headers = lines[0].split(',').map(h => h.trim());
            const rows = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                if (values.length >= headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] ? values[index].trim() : '';
                    });
                    rows.push(row);
                }
            }
            
            return rows;
        }
        
        // Fallback simulated data if real data fails
        async function loadSimulatedInternationalData() {
            console.log('Falling back to simulated international data');
            const simulatedData = [
                { country: 'CN', countryName: 'China', output: 14000000000000, employment: 780000000, type: 'country' },
                { country: 'JP', countryName: 'Japan', output: 5000000000000, employment: 67000000, type: 'country' },
                { country: 'DE', countryName: 'Germany', output: 4000000000000, employment: 45000000, type: 'country' },
                { country: 'IN', countryName: 'India', output: 3000000000000, employment: 520000000, type: 'country' },
                { country: 'GB', countryName: 'United Kingdom', output: 2800000000000, employment: 33000000, type: 'country' },
                { country: 'FR', countryName: 'France', output: 2700000000000, employment: 29000000, type: 'country' },
                { country: 'IT', countryName: 'Italy', output: 2000000000000, employment: 26000000, type: 'country' },
                { country: 'BR', countryName: 'Brazil', output: 1800000000000, employment: 95000000, type: 'country' },
                { country: 'CA', countryName: 'Canada', output: 1700000000000, employment: 19500000, type: 'country' },
                { country: 'AU', countryName: 'Australia', output: 1400000000000, employment: 12800000, type: 'country' },
                { country: 'KR', countryName: 'South Korea', output: 1600000000000, employment: 27000000, type: 'country' }
            ];
            
            // Add formatted values
            simulatedData.forEach(row => {
                row.outputFormatted = formatCurrency(row.output);
                row.employmentFormatted = formatNumber(row.employment);
            });
            
            return simulatedData;
        }
        
        // Load combined data (states + countries, excluding US country row)
        async function loadCombinedData() {
            try {
                updateDataInfo('Combined US state-level and international country data for comparison');
                
                // Ensure both datasets are loaded
                if (usStateData.length === 0) {
                    await loadUSStateData();
                }
                if (internationalData.length === 0) {
                    await loadInternationalData();
                }
                
                // Combine data (US country is already excluded from international data)
                combinedData = [...usStateData, ...internationalData];
                
                // Update data sources display for combined view with actual paths
                const combinedPaths = [];
                
                // Add US state paths
                usStateData.forEach(stateData => {
                    if (stateData.stateAbbr) {
                        const modelDir = `/useeio-json/models/2020/${stateData.stateAbbr}EEIOv1.0-s-20/`;
                        combinedPaths.push({
                            label: `${stateData.stateName} (${stateData.stateAbbr}) - Model Directory`,
                            path: modelDir,
                            type: 'useeio',
                            isLink: true,
                            isParent: true,
                            stateId: stateData.stateAbbr
                        });
                        // Add links to specific files used
                        const keyFiles = ['sectors.json', 'indicators.json', 'matrix/q.json', 'matrix/D.json'];
                        keyFiles.forEach(file => {
                            combinedPaths.push({
                                label: `${file}`,
                                path: modelDir + file,
                                type: 'useeio-file',
                                isLink: true,
                                isChild: true,
                                parentId: stateData.stateAbbr
                            });
                        });
                    }
                });
                
                // Add international country paths
                internationalData.forEach(countryData => {
                    if (countryData.country) {
                        combinedPaths.push({
                            label: `${countryData.countryName} (${countryData.country})`,
                            path: `../../exiobase/tradeflow/year/2019/${countryData.country}/domestic/trade_impacts.csv`,
                            type: 'exiobase',
                            isLink: true
                        });
                    }
                });
                
                updateDataSources('combined', combinedPaths);
                
                console.log('Loaded combined data:', combinedData.length + ' regions (states + countries)');
                return combinedData;
                
            } catch (error) {
                console.error('Error loading combined data:', error);
                return [];
            }
        }
        
        // Update data information display
        function updateDataInfo(description) {
            document.getElementById('dataDescription').textContent = description;
        }
        
        // Update data sources display
        function updateDataSources(dataType, paths = []) {
            const container = document.getElementById('dataSourcesContainer');
            const pathsDiv = document.getElementById('dataSourcesPaths');
            
            // Clear previous paths
            pathsDiv.innerHTML = '';
            
            if (paths.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            // Add paths based on data type
            paths.forEach(pathInfo => {
                const pathDiv = document.createElement('div');
                let pathClass = `data-path ${pathInfo.type || ''}`;
                
                // Add parent/child classes
                if (pathInfo.isParent) {
                    pathClass += ' parent-row';
                } else if (pathInfo.isChild) {
                    pathClass += ' child-row hidden'; // Start hidden
                    pathDiv.setAttribute('data-parent', pathInfo.parentId);
                }
                
                pathDiv.className = pathClass;
                
                const label = document.createElement('span');
                label.className = 'data-path-label';
                
                // Add expand arrow for parent rows
                if (pathInfo.isParent) {
                    const arrow = document.createElement('i');
                    arrow.className = 'expand-arrow ph ph-caret-right';
                    arrow.onclick = (e) => {
                        e.stopPropagation();
                        toggleSubRows(pathInfo.stateId || pathInfo.parentId, arrow);
                    };
                    label.appendChild(arrow);
                }
                
                const labelText = document.createElement('span');
                labelText.textContent = pathInfo.label + ':';
                label.appendChild(labelText);
                
                const pathContainer = document.createElement('span');
                
                if (pathInfo.isLink && pathInfo.path) {
                    const link = document.createElement('a');
                    link.href = pathInfo.path;
                    link.textContent = pathInfo.path;
                    link.target = '_blank';
                    link.style.color = '#007bff';
                    link.style.textDecoration = 'underline';
                    pathContainer.appendChild(link);
                } else {
                    pathContainer.textContent = pathInfo.path;
                }
                
                // Add 3-dot menu for interactive files
                if (pathInfo.isLink && (pathInfo.path.endsWith('.csv') || pathInfo.path.endsWith('.json'))) {
                    const menuContainer = document.createElement('div');
                    menuContainer.className = 'data-path-menu';
                    
                    const menuTrigger = document.createElement('i');
                    menuTrigger.className = 'menu-trigger ph ph-dots-three-vertical';
                    menuTrigger.title = 'File actions';
                    
                    const dropdownMenu = document.createElement('div');
                    dropdownMenu.className = 'dropdown-menu';
                    
                    // Show/Hide Table option
                    const tableAction = document.createElement('button');
                    tableAction.className = 'dropdown-item';
                    tableAction.innerHTML = '<i class="ph ph-table"></i> Show Table';
                    tableAction.onclick = (e) => {
                        e.stopPropagation();
                        toggleDataViewer(pathDiv, pathInfo.path);
                        closeAllDropdowns();
                    };
                    
                    // View JSON/CSV option
                    const viewAction = document.createElement('a');
                    viewAction.className = 'dropdown-item';
                    viewAction.href = pathInfo.path;
                    viewAction.target = '_blank';
                    const fileExt = pathInfo.path.endsWith('.csv') ? 'CSV' : 'JSON';
                    viewAction.innerHTML = `<i class="ph ph-eye"></i> View ${fileExt}`;
                    viewAction.onclick = (e) => {
                        e.stopPropagation();
                        closeAllDropdowns();
                    };
                    
                    // Download option
                    const downloadAction = document.createElement('a');
                    downloadAction.className = 'dropdown-item';
                    downloadAction.href = pathInfo.path;
                    downloadAction.target = '_blank';
                    downloadAction.download = '';
                    downloadAction.innerHTML = `<i class="ph ph-download"></i> Download ${fileExt}`;
                    downloadAction.onclick = (e) => {
                        e.stopPropagation();
                        closeAllDropdowns();
                    };
                    
                    dropdownMenu.appendChild(tableAction);
                    dropdownMenu.appendChild(viewAction);
                    dropdownMenu.appendChild(downloadAction);
                    
                    menuContainer.appendChild(menuTrigger);
                    menuContainer.appendChild(dropdownMenu);
                    
                    // Toggle dropdown on trigger click
                    menuTrigger.onclick = (e) => {
                        e.stopPropagation();
                        closeAllDropdowns();
                        dropdownMenu.classList.toggle('show');
                    };
                    
                    pathDiv.appendChild(menuContainer);
                }
                
                // Make div clickable for expand/collapse or data viewing (limited click area)
                if (pathInfo.isParent) {
                    pathDiv.onclick = (e) => {
                        // Don't trigger if clicking on menu, links, or tabulator tables
                        if (e.target.closest('.data-path-menu') || 
                            e.target.tagName === 'A' ||
                            e.target.closest('.csv-viewer-container') ||
                            e.target.closest('.tabulator')) {
                            return;
                        }
                        
                        // Only trigger if clicking on the label or path text area
                        if (e.target.closest('.data-path-label') || 
                            e.target.classList.contains('data-path')) {
                            const arrow = pathDiv.querySelector('.expand-arrow');
                            toggleSubRows(pathInfo.stateId || pathInfo.parentId, arrow);
                        }
                    };
                } else {
                    makeDataPathClickable(pathDiv, pathInfo.path);
                }
                
                pathDiv.appendChild(label);
                pathDiv.appendChild(pathContainer);
                pathsDiv.appendChild(pathDiv);
            });
            
            container.style.display = 'block';
        }
        
        // Update totals display
        function updateTotals(data, dataType = 'countries') {
            const totalOutput = data.reduce((sum, row) => sum + (row.output || 0), 0);
            const totalEmployment = data.reduce((sum, row) => sum + (row.employment || 0), 0);
            const totalRegions = data.length;
            
            let regionLabel = '';
            if (dataType === 'us') {
                regionLabel = ' states';
            } else if (dataType === 'international') {
                regionLabel = ' countries';
            } else if (dataType === 'combined') {
                const stateCount = data.filter(row => row.type === 'state').length;
                const countryCount = data.filter(row => row.type === 'country').length;
                regionLabel = ` regions (${stateCount} states + ${countryCount} countries)`;
            }
            
            document.getElementById('totalOutput').textContent = formatCurrency(totalOutput);
            document.getElementById('totalEmployment').textContent = formatNumber(totalEmployment);
            document.getElementById('totalRegions').textContent = totalRegions + regionLabel;
            
            document.getElementById('loadingTotals').style.display = 'none';
            document.getElementById('totalsDisplay').style.display = 'block';
        }
        
        // Create Tabulator table
        function createTable(data, dataType = 'international') {
            // Destroy existing table
            if (currentTable) {
                currentTable.destroy();
            }
            
            // Define columns based on data source
            let columns;
            
            if (dataType === 'us') {
                columns = [
                    {
                        title: "State",
                        field: "stateName",
                        width: 200,
                        formatter: function(cell) {
                            const data = cell.getRow().getData();
                            return `<a href="#state=${data.stateAbbr}" style="color: #2196f3; text-decoration: none;">${data.stateName}</a>`;
                        }
                    },
                    {
                        title: "Economic Output",
                        field: "outputFormatted",
                        width: 150,
                        sorter: function(a, b, aRow, bRow) {
                            return aRow.getData().output - bRow.getData().output;
                        }
                    },
                    {
                        title: "Employment",
                        field: "employmentFormatted", 
                        width: 120,
                        sorter: function(a, b, aRow, bRow) {
                            return aRow.getData().employment - bRow.getData().employment;
                        }
                    }
                ];
            } else if (dataType === 'international') {
                // Check if US data is included and has extended columns
                const hasUSData = data.find(row => row.country === 'US' && row.allColumns);
                
                if (hasUSData) {
                    // Create dynamic columns based on US data structure
                    columns = [
                        {
                            title: "Country",
                            field: "countryName",
                            width: 150,
                            frozen: true,
                            formatter: function(cell) {
                                const data = cell.getRow().getData();
                                return `<a href="#country=${data.country}" style="color: #2196f3; text-decoration: none;">${data.countryName}</a>`;
                            }
                        }
                    ];
                    
                    // Add columns for key metrics first
                    const keyColumns = [
                        { field: 'outputFormatted', title: 'Trade Flow Value', dataField: 'output' },
                        { field: 'employmentFormatted', title: 'Employment', dataField: 'employment' },
                        { field: 'CO2_total_formatted', title: 'CO2 Total', dataField: 'CO2_total' },
                        { field: 'Energy_total_formatted', title: 'Energy Total', dataField: 'Energy_total' },
                        { field: 'Water_total_formatted', title: 'Water Total', dataField: 'Water_total' },
                        { field: 'transactionCount', title: 'Transactions', dataField: 'transactionCount' }
                    ];
                    
                    keyColumns.forEach(col => {
                        columns.push({
                            title: col.title,
                            field: col.field,
                            width: 120,
                            sorter: function(a, b, aRow, bRow) {
                                return (aRow.getData()[col.dataField] || 0) - (bRow.getData()[col.dataField] || 0);
                            }
                        });
                    });
                    
                    // Add remaining columns from US data (excluding already added ones)
                    if (hasUSData.allColumns) {
                        const excludeColumns = ['trade_id', 'year', 'region1', 'region2', 'industry1', 'industry2', 
                                               'amount', 'Employment_total', 'CO2_total', 'Energy_total', 'Water_total'];
                        
                        hasUSData.allColumns.forEach(colName => {
                            if (!excludeColumns.includes(colName) && 
                                !columns.find(c => c.field === colName + '_formatted')) {
                                columns.push({
                                    title: colName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                                    field: colName + '_formatted',
                                    width: 100,
                                    sorter: function(a, b, aRow, bRow) {
                                        return (aRow.getData()[colName] || 0) - (bRow.getData()[colName] || 0);
                                    }
                                });
                            }
                        });
                    }
                } else {
                    // Standard international columns
                    columns = [
                        {
                            title: "Country",
                            field: "countryName",
                            width: 200,
                            formatter: function(cell) {
                                const data = cell.getRow().getData();
                                return `<a href="#country=${data.country}" style="color: #2196f3; text-decoration: none;">${data.countryName}</a>`;
                            }
                        },
                        {
                            title: "Trade Flow Value",
                            field: "outputFormatted",
                            width: 150,
                            sorter: function(a, b, aRow, bRow) {
                                return aRow.getData().output - bRow.getData().output;
                            }
                        },
                        {
                            title: "Employment Impact",
                            field: "employmentFormatted",
                            width: 150,
                            sorter: function(a, b, aRow, bRow) {
                                return aRow.getData().employment - bRow.getData().employment;
                            }
                        }
                    ];
                }
            } else if (dataType === 'combined') {
                columns = [
                    {
                        title: "Region",
                        field: "regionName",
                        width: 200,
                        formatter: function(cell) {
                            const data = cell.getRow().getData();
                            if (data.type === 'state') {
                                return `<a href="#state=${data.stateAbbr}" style="color: #2196f3; text-decoration: none;">${data.stateName}</a>`;
                            } else {
                                return `<a href="#country=${data.country}" style="color: #2196f3; text-decoration: none;">${data.countryName}</a>`;
                            }
                        }
                    },
                    {
                        title: "Type",
                        field: "type",
                        width: 80,
                        formatter: function(cell) {
                            const value = cell.getValue();
                            const color = value === 'state' ? '#1976d2' : '#388e3c';
                            return `<span style="color: ${color}; font-weight: bold; text-transform: capitalize;">${value}</span>`;
                        }
                    },
                    {
                        title: "Economic Output",
                        field: "outputFormatted",
                        width: 150,
                        sorter: function(a, b, aRow, bRow) {
                            return aRow.getData().output - bRow.getData().output;
                        }
                    },
                    {
                        title: "Employment",
                        field: "employmentFormatted",
                        width: 120,
                        sorter: function(a, b, aRow, bRow) {
                            return aRow.getData().employment - bRow.getData().employment;
                        }
                    }
                ];
                
                // Add regionName field for combined view
                data.forEach(row => {
                    row.regionName = row.type === 'state' ? row.stateName : row.countryName;
                });
            }
            
            // Create new table
            currentTable = new Tabulator("#table", {
                data: data,
                columns: columns,
                layout: "fitColumns",
                pagination: "local",
                paginationSize: 500,
                paginationSizeSelector: [10, 25, 50, 100, 500],
                movableColumns: true,
                resizableRows: true,
                initialSort: [
                    {column: "output", dir: "desc"}
                ],
                tooltips: true
            });
            
            console.log('Created table with', data.length, 'rows');
        }
        
        // Handle data source toggle
        async function handleDataSourceChange(newSource, updateHash = true) {
            if (newSource === currentDataSource) return;
            
            currentDataSource = newSource;
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('table').style.display = 'none';
            document.getElementById('loadingTotals').style.display = 'block';
            document.getElementById('totalsDisplay').style.display = 'none';
            
            try {
                let data;
                
                if (newSource === 'us') {
                    data = await loadUSStateData();
                    if (updateHash) {
                        window.location.hash = 'state=all';
                    }
                } else if (newSource === 'international') {
                    data = await loadInternationalData();
                    if (updateHash) {
                        // Default to country=US for international view
                        window.location.hash = 'country=US';
                    }
                } else if (newSource === 'combined') {
                    data = await loadCombinedData();
                    if (updateHash) {
                        window.location.hash = 'country=all&state=all';
                    }
                }
                
                createTable(data, newSource);
                updateTotals(data, newSource);
                
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('table').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loadingMessage').innerHTML = '<div style="color: red;">Error loading data. Please try again.</div>';
            }
        }
        
        // Initialize the page
        async function initializePage() {
            console.log('Initializing dual-use footprint chart...');
            
            // Set up event listeners for toggle
            document.querySelectorAll('input[name="dataSource"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    console.log('Data source changed to:', this.value);
                    handleDataSourceChange(this.value);
                });
            });
            
            // Check URL hash to determine initial view
            const hash = window.location.hash.substring(1);
            let initialView = 'international'; // Default to international
            
            if (hash.includes('country=all&state=all')) {
                initialView = 'combined';
                document.querySelector('input[value="combined"]').checked = true;
            } else if (hash.startsWith('state=all') || hash.startsWith('state=')) {
                initialView = 'us';
                document.querySelector('input[value="us"]').checked = true;
            } else if (hash.startsWith('country=all') || hash.startsWith('country=')) {
                initialView = 'international';
                document.querySelector('input[value="international"]').checked = true;
            } else {
                // Default to country=US when no specific country or state is specified
                initialView = 'international';
                document.querySelector('input[value="international"]').checked = true;
                // Set the hash to country=US for default display
                window.location.hash = 'country=US';
            }
            
            // Reset currentDataSource to force initial load
            currentDataSource = null;
            
            // Load initial data (don't update hash during initialization)
            await handleDataSourceChange(initialView, false);
            
            console.log('Page initialization complete');
        }
        
        // Handle URL hash changes for filtering
        function handleHashChange() {
            const hash = window.location.hash.substring(1);
            if (hash) {
                console.log('Hash changed:', hash);
                
                // Handle combined view
                if (hash.includes('country=all&state=all')) {
                    if (currentDataSource !== 'combined') {
                        document.querySelector('input[value="combined"]').checked = true;
                        handleDataSourceChange('combined', false);
                    }
                }
                // Handle state view (both state=all and specific states)
                else if (hash.startsWith('state=')) {
                    if (currentDataSource !== 'us') {
                        document.querySelector('input[value="us"]').checked = true;
                        handleDataSourceChange('us', false);
                    }
                    
                    // Extract state abbreviation for potential filtering
                    const stateAbbr = hash.split('=')[1];
                    console.log('State view - state:', stateAbbr);
                }
                // Handle country view (both country=all and specific countries)
                else if (hash.startsWith('country=')) {
                    if (currentDataSource !== 'international') {
                        document.querySelector('input[value="international"]').checked = true;
                        handleDataSourceChange('international', false);
                    }
                    
                    // Extract country code for potential filtering
                    const countryCode = hash.split('=')[1];
                    console.log('Country view - country:', countryCode);
                    
                    // If country=US, reload international data to include US
                    if (countryCode === 'US' && currentDataSource === 'international') {
                        // Force reload to include US data
                        internationalData = [];
                        handleDataSourceChange('international', false);
                    }
                }
            }
        }
        
        // Set up hash change listener
        window.addEventListener('hashchange', handleHashChange);
        
        // Global functions for dropdown management
        function closeAllDropdowns() {
            document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                menu.classList.remove('show');
            });
        }
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', closeAllDropdowns);
        
        // Toggle sub-rows visibility
        function toggleSubRows(parentId, arrow) {
            const childRows = document.querySelectorAll(`[data-parent="${parentId}"]`);
            const isExpanded = arrow.classList.contains('expanded');
            
            childRows.forEach(row => {
                if (isExpanded) {
                    row.classList.add('hidden');
                } else {
                    row.classList.remove('hidden');
                }
            });
            
            // Toggle arrow direction
            if (isExpanded) {
                arrow.classList.remove('expanded');
            } else {
                arrow.classList.add('expanded');
            }
        }
        
        // Data Viewer Functions (handles both CSV and JSON)
        function toggleDataViewer(pathDiv, filePath) {
            const existingViewer = pathDiv.querySelector('.csv-viewer-container');
            const menuButton = pathDiv.querySelector('.dropdown-item');
            
            if (existingViewer) {
                // Toggle visibility and update button text
                const isVisible = existingViewer.style.display !== 'none';
                existingViewer.style.display = isVisible ? 'none' : 'block';
                if (menuButton) {
                    menuButton.innerHTML = isVisible ? 
                        '<i class="ph ph-table"></i> Show Table' : 
                        '<i class="ph ph-table"></i> Hide Table';
                }
                return;
            }
            
            // Create new viewer container
            const viewerContainer = document.createElement('div');
            viewerContainer.className = 'csv-viewer-container';
            
            const loadingMsg = document.createElement('div');
            const fileType = filePath.endsWith('.json') ? 'JSON' : 'CSV';
            loadingMsg.textContent = `Loading ${fileType} data...`;
            loadingMsg.style.textAlign = 'center';
            loadingMsg.style.padding = '20px';
            loadingMsg.style.fontStyle = 'italic';
            loadingMsg.style.color = '#666';
            
            viewerContainer.appendChild(loadingMsg);
            pathDiv.appendChild(viewerContainer);
            viewerContainer.style.display = 'block';
            
            // Update button text
            if (menuButton) {
                menuButton.innerHTML = '<i class="ph ph-table"></i> Hide Table';
            }
            
            // Load and display data
            if (filePath.endsWith('.json')) {
                loadJSONData(filePath, viewerContainer);
            } else {
                loadCSVData(filePath, viewerContainer);
            }
        }
        
        // Make data-path clickable for main action (limited to label/path area)
        function makeDataPathClickable(pathDiv, filePath) {
            if (filePath && (filePath.endsWith('.csv') || filePath.endsWith('.json'))) {
                pathDiv.onclick = (e) => {
                    // Don't trigger if clicking on menu, links, or tabulator tables
                    if (e.target.closest('.data-path-menu') || 
                        e.target.tagName === 'A' || 
                        e.target.closest('.csv-viewer-container') ||
                        e.target.closest('.tabulator')) {
                        return;
                    }
                    
                    // Only trigger if clicking on the label or path text area
                    if (e.target.closest('.data-path-label') || 
                        e.target.classList.contains('data-path')) {
                        toggleDataViewer(pathDiv, filePath);
                    }
                };
            }
        }
        
        async function loadCSVData(csvPath, container) {
            try {
                const response = await fetch(csvPath);
                if (!response.ok) {
                    throw new Error(`Failed to fetch CSV: ${response.status}`);
                }
                
                const csvText = await response.text();
                const csvData = parseCSVForViewer(csvText);
                
                if (csvData.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">No data found in CSV file</div>';
                    return;
                }
                
                // Create table container
                const tableContainer = document.createElement('div');
                tableContainer.className = 'csv-viewer-table';
                
                // Create unique ID for this table
                const tableId = 'csv-table-' + Date.now();
                tableContainer.id = tableId;
                
                container.innerHTML = '';
                container.appendChild(tableContainer);
                
                // Determine columns from first row
                const columns = Object.keys(csvData[0]).map(key => ({
                    title: key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                    field: key,
                    width: 120,
                    formatter: function(cell) {
                        const value = cell.getValue();
                        // Format numbers
                        if (!isNaN(value) && value !== '' && value !== null) {
                            const num = parseFloat(value);
                            if (num >= 1e9) {
                                return (num / 1e9).toFixed(2) + 'B';
                            } else if (num >= 1e6) {
                                return (num / 1e6).toFixed(2) + 'M';
                            } else if (num >= 1e3) {
                                return (num / 1e3).toFixed(2) + 'K';
                            } else if (num % 1 !== 0) {
                                return num.toFixed(3);
                            }
                        }
                        return value;
                    }
                }));
                
                // Create Tabulator table
                new Tabulator(`#${tableId}`, {
                    data: csvData,
                    columns: columns,
                    layout: "fitData",
                    pagination: "local",
                    paginationSize: 25,
                    paginationSizeSelector: [10, 25, 50, 100],
                    movableColumns: true,
                    resizableRows: true,
                    height: "300px",
                    tooltips: true,
                    headerFilterPlaceholder: "Filter...",
                    headerFilter: true
                });
                
            } catch (error) {
                console.error('Error loading CSV:', error);
                container.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc3545;">Error loading CSV: ${error.message}</div>`;
            }
        }
        
        function parseCSVForViewer(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) return [];
            
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const rows = [];
            
            for (let i = 1; i < lines.length && i < 1001; i++) { // Limit to 1000 rows for performance
                const values = lines[i].split(',');
                if (values.length >= headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] ? values[index].trim().replace(/"/g, '') : '';
                    });
                    rows.push(row);
                }
            }
            
            return rows;
        }
        
        // JSON Data Loader
        async function loadJSONData(jsonPath, container) {
            try {
                const response = await fetch(jsonPath);
                if (!response.ok) {
                    throw new Error(`Failed to fetch JSON: ${response.status}`);
                }
                
                const jsonData = await response.json();
                
                // Convert JSON to tabular format
                let tableData = [];
                
                if (Array.isArray(jsonData)) {
                    // If it's an array, use as-is
                    tableData = jsonData;
                } else if (typeof jsonData === 'object') {
                    // If it's an object, convert to array of key-value pairs
                    if (jsonData.data && Array.isArray(jsonData.data)) {
                        // Handle structured data with 'data' property
                        tableData = jsonData.data;
                    } else {
                        // Convert object properties to rows
                        tableData = Object.keys(jsonData).map(key => ({
                            key: key,
                            value: typeof jsonData[key] === 'object' ? 
                                JSON.stringify(jsonData[key]) : jsonData[key]
                        }));
                    }
                }
                
                if (tableData.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">No tabular data found in JSON file</div>';
                    return;
                }
                
                // Create table container
                const tableContainer = document.createElement('div');
                tableContainer.className = 'csv-viewer-table';
                
                // Create unique ID for this table
                const tableId = 'json-table-' + Date.now();
                tableContainer.id = tableId;
                
                container.innerHTML = '';
                container.appendChild(tableContainer);
                
                // Determine columns from first row
                const columns = Object.keys(tableData[0]).map(key => ({
                    title: key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                    field: key,
                    width: 120,
                    formatter: function(cell) {
                        const value = cell.getValue();
                        // Format numbers
                        if (!isNaN(value) && value !== '' && value !== null) {
                            const num = parseFloat(value);
                            if (num >= 1e9) {
                                return (num / 1e9).toFixed(2) + 'B';
                            } else if (num >= 1e6) {
                                return (num / 1e6).toFixed(2) + 'M';
                            } else if (num >= 1e3) {
                                return (num / 1e3).toFixed(2) + 'K';
                            } else if (num % 1 !== 0) {
                                return num.toFixed(3);
                            }
                        }
                        return value;
                    }
                }));
                
                // Create Tabulator table
                new Tabulator(`#${tableId}`, {
                    data: tableData,
                    columns: columns,
                    layout: "fitData",
                    pagination: "local",
                    paginationSize: 25,
                    paginationSizeSelector: [10, 25, 50, 100],
                    movableColumns: true,
                    resizableRows: true,
                    height: "300px",
                    tooltips: true,
                    headerFilterPlaceholder: "Filter...",
                    headerFilter: true
                });
                
            } catch (error) {
                console.error('Error loading JSON:', error);
                container.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc3545;">Error loading JSON: ${error.message}</div>`;
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>