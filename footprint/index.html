<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>My Profile</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon">
    
    <!-- Shared CSS from localsite -->
    <script type="text/javascript" src="../../localsite/js/localsite.js?showheader=true&showsearch=false"></script>
    <link type="text/css" rel="stylesheet" href="../../localsite/css/base.css" id="/localsite/css/base.css"/>
    <link type="text/css" rel="stylesheet" href="../../localsite/css/base-tabulator.css" id="/localsite/css/base-tabulator.css"/>
    
    <!-- Side Nav -->
    <link rel="stylesheet" href="../../localsite/css/nav.css">
    <script src="../../localsite/js/nav.js"></script>
    
    <!-- Tabulator CSS -->
    <link href="https://unpkg.com/tabulator-tables@5.2.7/dist/css/tabulator.min.css" rel="stylesheet">
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        .toggle-data-container {
            margin: 10px 0;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }
        
        .toggle-options {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .github-link {
            margin-left: auto;
            display: flex;
            align-items: center;
        }
        
        .github-link img {
            width: 40px;
            height: auto;
            transition: opacity 0.3s;
        }
        
        .github-link img:hover {
            opacity: 0.8;
        }
        
        .toggle-data-container label {
            margin: 0px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .toggle-data-container input[type="radio"] {
            margin-right: 5px;
        }
        
        .file-selection-container {
            margin: 20px 0;
            padding: 15px;
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            border-radius: 5px;
        }
        
        .selector-row {
            display: flex;
            gap: 20px;
            align-items: flex-end;
        }
        
        .selector-group {
            flex: 1;
        }
        
        .file-selection-container label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #1976d2;
        }
        
        .file-selector,
        .trade-type-selector {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #2196f3;
            border-radius: 4px;
            font-size: 0.95em;
            background-color: white;
            cursor: pointer;
        }
        
        .file-selector:focus,
        .trade-type-selector:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 5px rgba(33, 150, 243, 0.3);
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #666;
        }
        
        .data-info {
            margin: 15px 0;
            padding: 10px;
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            border-radius: 3px;
        }
        
        .dark .toggle-data-container {
            background-color: #555;
            color: #fff;
        }
        
        .dark .github-link img {
            filter: brightness(0.8);
        }
        
        .dark .github-link img:hover {
            filter: brightness(1);
        }
        
        .dark .file-selection-container {
            background-color: #555;
            color: #fff;
            border-left-color: #888;
        }
        
        .dark .data-info {
            background-color: #555;
            color: #fff;
            border-left-color: #888;
        }
        
        .dark .totals {
            background-color: #555;
            color: #fff;
            border-color: #888;
        }
        
        .data-info-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .year-selector {
            padding: 5px 10px;
            border: 1px solid #2196f3;
            border-radius: 3px;
            background: white;
            color: #1976d2;
            font-size: 0.9em;
            cursor: pointer;
            /* Keep the regular dropdown arrow */
            -webkit-appearance: menulist;
            -moz-appearance: menulist;
            appearance: menulist;
        }
        
        .dark .year-selector {
            background: #777;
            color: #fff;
            border-color: #888;
        }
        
        .totals {
            margin: 15px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }
        
        .totals h3 {
            margin-top: 0;
            color: #495057;
        }
        
        #table {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .data-sources {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            font-family: monospace;
        }
        
        .data-sources h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #495057;
            font-family: inherit;
        }
        
        .data-path {
            background-color: #e9ecef;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 3px;
            font-size: 0.9em;
            word-break: break-all;
            border-left: 4px solid #007bff;
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .data-path:hover {
            background-color: #dee2e6;
        }
        
        .data-path.exiobase {
            border-left-color: #28a745;
        }
        
        .data-path.fallback {
            border-left-color: #ffc107;
            background-color: #fff3cd;
        }
        
        .data-path.useeio-file {
            border-left-color: #17a2b8;
            background-color: #efefef;
            margin-left: 20px;
            font-size: 0.85em;
        }
        
        .data-path-label {
            font-weight: bold;
            color: #495057;
            margin-right: 8px;
        }
        
        .expand-arrow {
            display: inline-block;
            margin-right: 8px;
            color: #6c757d;
            cursor: pointer;
            font-size: 1.2em;
            transition: transform 0.2s ease, color 0.2s;
            vertical-align: middle;
        }
        
        .expand-arrow:hover {
            color: #495057;
        }
        
        .expand-arrow.expanded {
            transform: rotate(90deg);
        }
        
        .data-path.parent-row {
            cursor: pointer;
        }
        
        .data-path.child-row {
            margin-left: 30px;
            border-left-color: #6c757d;
            background-color: #f8f9fa;
        }
        
        .data-path.child-row.hidden {
            display: none;
        }
        
        .data-path-menu {
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 10;
        }
        
        .menu-trigger {
            display: inline-block;
            padding: 4px;
            color: #6c757d;
            cursor: pointer;
            font-size: 1.8em;
            transition: color 0.2s;
            border-radius: 3px;
        }
        
        .menu-trigger:hover {
            color: #495057;
            background-color: rgba(0,0,0,0.1);
        }
        
        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-width: 150px;
            z-index: 1000;
            display: none;
        }
        
        .dropdown-menu.show {
            display: block;
        }
        
        .dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 0.9em;
            color: #495057;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .dropdown-item i {
            font-size: 1.6em;
        }
        
        .dropdown-item:hover {
            background-color: #f8f9fa;
        }
        
        .dropdown-item:first-child {
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
        }
        
        .dropdown-item:last-child {
            border-bottom-left-radius: 5px;
            border-bottom-right-radius: 5px;
        }
        
        .dropdown-divider {
            height: 1px;
            background-color: #dee2e6;
            margin: 4px 0;
        }
        
        .csv-viewer-container {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            display: none;
        }
        
        .csv-viewer-table {
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            max-height: 400px;
            overflow: auto;
        }
        
        .csv-viewer-table .tabulator-paginator .tabulator-page-size::after,
        #table .tabulator-paginator .tabulator-page-size::after {
            display: none !important;
        }
        
        .csv-viewer-table .tabulator-page-size,
        #table .tabulator-page-size {
            background: none !important;
        }
        
        .csv-viewer-table .tabulator-page-size select,
        #table .tabulator-page-size select {
            background: none !important;
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            appearance: none !important;
        }
        
        /* Industry Filter Styles */
        .industry-filter-container {
            margin: 20px 0;
            padding: 15px;
            background-color: #f0f8ff;
            border-left: 4px solid #0066cc;
            border-radius: 5px;
            display: none; /* Initially hidden */
        }
        
        .industry-filter-row {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }
        
        .industry-filter-group {
            position: relative;
        }
        
        .industry-filter-group:first-child {
            flex: 0 0 200px; /* Fixed width for category popup */
        }
        
        .industry-filter-group:last-child {
            flex: 1; /* Remaining space for industry dropdown */
        }
        
        .industry-filter-container label {
            display: block;
            margin-top: 0;
            margin-bottom: 8px;
            font-weight: bold;
            color: #000;
        }
        
        .dark .industry-filter-container label {
            color: #fff;
        }
        
        .industry-dropdown, .category-button {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #0066cc;
            border-radius: 4px;
            font-size: 0.95em;
            background-color: white;
            cursor: pointer;
            height: 40px;
            box-sizing: border-box;
            margin-bottom: 0px;
        }
        
        .category-button {
            background-color: #e6f3ff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 40px;
        }
        
        .category-popup {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #0066cc;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .category-popup.show {
            display: block;
        }
        
        .category-item {
            padding: 8px 12px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .category-item:last-child {
            border-bottom: none;
        }
        
        .category-item:hover {
            background-color: #f0f8ff;
        }
        
        .category-item input[type="checkbox"] {
            margin: 0;
        }
        
        .dark .industry-filter-container {
            background-color: #444;
            color: #fff;
            border-left-color: #888;
        }
        
        .dark .category-popup {
            background: #555;
            border-color: #888;
            color: #fff;
        }
        
        .dark .category-item:hover {
            background-color: #666;
        }
        
        .dark .category-button {
            background-color: #555;
            color: #fff;
            border-color: #888;
        }
        
        .dark .industry-dropdown {
            background-color: #555;
            color: #fff;
            border-color: #888;
        }
        
        .dark .category-item {
            color: #fff;
        }
        
        .dark .category-item label {
            color: #fff !important;
        }
        
        /* USEEIO Source Message Styles */
        #useeioSourceMessage {
            margin: 15px 0;
            padding: 10px;
            background-color: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 4px;
            font-size: 0.9em;
            color: #1976d2;
            text-align: center;
        }
        
        .dark #useeioSourceMessage {
            background-color: #444;
            border-color: #888;
            color: #bbb;
        }
        
        /* Data path layout improvements */
        .data-path-label {
            display: block;
            margin-bottom: 4px;
        }
        
        .data-path.parent-row .data-path-label {
            margin-bottom: 8px;
        }
        
        .dark .data-path span {
            color: #bbb;
        }
        
        .category-item {
            cursor: pointer;
            user-select: none;
        }
        
        .category-item label {
            cursor: pointer;
            user-select: none;
            flex: 1;
            color: #0066cc; /* Blue text in light mode */
        }
    </style>
</head>

<body>
    <div class="content contentpadding" style="position: relative; padding-top:0px">
        
        <!-- Data Source Toggle -->
        <div class="toggle-data-container">
            <div class="toggle-options">
                <label>
                    <input type="radio" name="dataSource" value="international" checked> Countries
                </label>
                <label>
                    <input type="radio" name="dataSource" value="us"> US States
                </label>
                <label>
                    <input type="radio" name="dataSource" value="combined"> Combined
                </label>
            </div>
            <a href="https://github.com/ModelEarth/exiobase/tree/main/tradeflow" class="github-link" target="trade_github">
                <img src="../../localsite/img/icon/github/github.png" alt="Exiobase Tradeflow Repository">
            </a>
        </div>
        
        <!-- File Selection Dropdown (for specific countries) -->
        <div id="fileSelectionContainer" class="file-selection-container" style="display: none;">
            <div class="selector-row">
                <div class="selector-group">
                    <label for="tradeTypeSelector"><strong>Trade Type:</strong></label>
                    <select id="tradeTypeSelector" class="trade-type-selector">
                        <option value="domestic">Domestic Trade</option>
                        <option value="imports">Imports</option>
                        <option value="exports">Exports</option>
                    </select>
                </div>
                <div class="selector-group">
                    <label for="fileSelector"><strong>Data File:</strong></label>
                    <select id="fileSelector" class="file-selector">
                        <option value="trade_impact.csv">Environmental Impacts (trade_impact.csv)</option>
                        <option value="trade_employment.csv">Employment Data (trade_employment.csv)</option>
                        <option value="trade_factor.csv">Environmental Factors (trade_factor.csv)</option>
                        <option value="trade_material.csv">Material Flows (trade_material.csv)</option>
                        <option value="trade_resource.csv">Resource Usage (trade_resource.csv)</option>
                        <option value="trade.csv">Industry Flow Data (trade.csv)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Industry Filter Section -->
        <div id="industryFilterContainer" class="industry-filter-container">
            <div class="industry-filter-row">
                <div class="industry-filter-group">
                    <label for="industryCategory"><strong>Categories:</strong></label>
                    <div class="category-button" id="industrycat">
                        <span id="categoryDisplay">All Categories</span>
                        <i class="ph ph-caret-down"></i>
                    </div>
                    <div id="categoryPopup" class="category-popup">
                        <!-- Categories will be loaded dynamically -->
                    </div>
                </div>
                <div class="industry-filter-group">
                    <label for="industry"><strong>Industry:</strong></label>
                    <select id="industry" class="industry-dropdown">
                        <option value="all">All Industries</option>
                        <!-- Industries will be loaded dynamically -->
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Data Information Display -->
        <div id="dataInfo" class="data-info">
            <div class="data-info-content">
                <div>
                    <strong>Current Data (<span id="currentYear">2022</span>):</strong> 
                    <span id="dataDescription">US state-level economic output and employment data</span>
                </div>
                <select id="yearSelector" class="year-selector">
                    <option value="2019">2019</option>
                    <option value="2022" selected>2022</option>
                </select>
            </div>
        </div>
        
        <!-- Totals Summary -->
        <div id="totalsContainer" class="totals">
            <h3>Summary Totals</h3>
            <div id="totalsContent">
                <div id="loadingTotals" class="loading">Loading totals...</div>
                <div id="totalsDisplay" style="display: none;">
                    <strong>Total Output:</strong> <span id="totalOutput">$0</span><br>
                    <strong>Total Employment:</strong> <span id="totalEmployment">0</span><br>
                    <strong>Regions/Countries:</strong> <span id="totalRegions">0</span>
                </div>
            </div>
        </div>
        
        <!-- Main Data Table -->
        <div id="loadingMessage" class="loading">Loading data...</div>
        <div id="table"></div>

        <!-- Data Sources Display -->
        <div id="dataSourcesContainer" class="data-sources" style="display: none;">
            <h3>Data Sources</h3>
            <div id="dataSourcesPaths"></div>
        </div>

        <br>
        <a href="../../trade/footprint/">State Reports</a>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://unpkg.com/tabulator-tables@5.2.7/dist/js/tabulator.min.js"></script>
    <script src="../../trade/dist/useeio.js"></script>
    <script src="../../trade/footprint/config.js"></script>
    
    <script>
        // Global variables
        let currentTable = null;
        let currentDataSource = 'international';
        let selectedTradeType = 'domestic'; // Default trade type
        let selectedDataFile = 'trade_impact.csv'; // Default file
        let usStateData = [];
        let internationalData = [];
        let combinedData = [];
        let industriesData = [];
        let selectedCategories = [];
        let selectedIndustry = 'all';
        let filteredData = [];
        let useLocalUseeio = null; // null = not checked, true = local, false = github
        let useeioSourceMessageShown = false;
        
        // Get selected year from dropdown
        function getSelectedYear() {
            const yearSelector = document.getElementById('yearSelector');
            return yearSelector ? yearSelector.value : '2022';
        }
        
        // Load industries data for filtering
        async function loadIndustriesData() {
            try {
                const selectedYear = getSelectedYear();
                const csvPath = `${tradeData}year/${selectedYear}/industry.csv`;
                
                const response = await fetch(csvPath);
                if (!response.ok) {
                    throw new Error(`Failed to fetch industries CSV: ${response.status}`);
                }
                
                const csvText = await response.text();
                const rows = parseCSV(csvText);
                
                industriesData = rows;
                console.log('Loaded industries data:', industriesData.length + ' industries');
                
                // Populate category checkboxes
                populateCategoryCheckboxes();
                
                // Populate industry dropdown
                populateIndustryDropdown();
                
                return industriesData;
                
            } catch (error) {
                console.error('Error loading industries data:', error);
                industriesData = [];
                return [];
            }
        }
        
        // Populate category checkboxes
        function populateCategoryCheckboxes() {
            const popup = document.getElementById('categoryPopup');
            
            // Get unique categories
            const categories = [...new Set(industriesData.map(row => row.category))]
                .filter(cat => cat && cat.trim() !== '')
                .sort();
            
            popup.innerHTML = '';
            
            categories.forEach(category => {
                const categoryItem = document.createElement('div');
                categoryItem.className = 'category-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `cat-${category.replace(/\s+/g, '-')}`;
                checkbox.value = category;
                checkbox.addEventListener('change', handleCategoryChange);
                
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = category;
                label.style.cursor = 'pointer';
                label.style.marginBottom = '0';
                label.style.fontWeight = 'normal';
                
                // Make entire row clickable
                categoryItem.addEventListener('click', function(e) {
                    // Prevent event bubbling if clicking directly on checkbox
                    if (e.target === checkbox) {
                        return;
                    }
                    // Toggle checkbox for any other click in the row
                    e.preventDefault();
                    e.stopPropagation();
                    checkbox.checked = !checkbox.checked;
                    // Trigger change event to update filters
                    const changeEvent = new Event('change', { bubbles: true });
                    checkbox.dispatchEvent(changeEvent);
                });
                
                categoryItem.appendChild(checkbox);
                categoryItem.appendChild(label);
                popup.appendChild(categoryItem);
            });
        }
        
        // Populate industry dropdown
        function populateIndustryDropdown() {
            const dropdown = document.getElementById('industry');
            
            // Clear existing options except "All Industries"
            dropdown.innerHTML = '<option value="all">All Industries</option>';
            
            // Filter industries based on selected categories
            let filteredIndustries = industriesData;
            
            if (selectedCategories.length > 0) {
                filteredIndustries = industriesData.filter(row => 
                    selectedCategories.includes(row.category)
                );
            }
            
            // Add filtered industries to dropdown
            filteredIndustries.forEach(industry => {
                const option = document.createElement('option');
                option.value = industry.industry_id;
                option.textContent = industry.name;
                dropdown.appendChild(option);
            });
        }
        
        // Handle category checkbox changes
        function handleCategoryChange() {
            // Update selected categories array
            selectedCategories = [];
            document.querySelectorAll('#categoryPopup input[type="checkbox"]:checked').forEach(cb => {
                selectedCategories.push(cb.value);
            });
            
            // Update category display
            const categoryDisplay = document.getElementById('categoryDisplay');
            if (selectedCategories.length === 0) {
                categoryDisplay.textContent = 'All Categories';
            } else if (selectedCategories.length === 1) {
                categoryDisplay.textContent = selectedCategories[0];
            } else {
                categoryDisplay.textContent = `${selectedCategories.length} Categories`;
            }
            
            // Repopulate industry dropdown with filtered industries
            populateIndustryDropdown();
            
            // Reset industry selection to "all" when categories change
            document.getElementById('industry').value = 'all';
            selectedIndustry = 'all';
            
            // Apply filters and refresh report
            applyIndustryFilters();
        }
        
        // Handle industry dropdown change
        function handleIndustryChange() {
            selectedIndustry = document.getElementById('industry').value;
            applyIndustryFilters();
        }
        
        // Apply industry filters and refresh report
        async function applyIndustryFilters() {
            // Update URL hash with filter values
            updateHashWithFilters();
            
            // Save filter values to browser cache
            saveFiltersToCache();
            
            // Filter current data and refresh table
            await filterDataByIndustry();
        }
        
        // Filter current data by industry
        async function filterDataByIndustry() {
            let currentData;
            
            if (currentDataSource === 'us') {
                // For US states, no industry filtering applies
                filteredData = usStateData;
                createTable(filteredData, currentDataSource);
                updateTotals(filteredData, currentDataSource);
                return;
            } else if (currentDataSource === 'international') {
                currentData = internationalData;
            } else if (currentDataSource === 'combined') {
                currentData = combinedData;
            } else {
                return;
            }
            
            // Check if industry filtering is needed
            const needsFiltering = selectedCategories.length > 0 || selectedIndustry !== 'all';
            
            if (needsFiltering) {
                console.log('Applying industry filters:', {
                    categories: selectedCategories,
                    industry: selectedIndustry
                });
                
                // Show loading state
                document.getElementById('loadingMessage').style.display = 'block';
                document.getElementById('table').style.display = 'none';
                
                try {
                    // Reload data with industry filtering
                    if (currentDataSource === 'international') {
                        filteredData = await loadFilteredInternationalData();
                    } else if (currentDataSource === 'combined') {
                        // Reload international portion with filtering
                        const filteredInternational = await loadFilteredInternationalData();
                        filteredData = [...usStateData, ...filteredInternational];
                    }
                    
                    // Hide loading state
                    document.getElementById('loadingMessage').style.display = 'none';
                    document.getElementById('table').style.display = 'block';
                    
                } catch (error) {
                    console.error('Error applying industry filters:', error);
                    // Fallback to unfiltered data
                    filteredData = currentData;
                    document.getElementById('loadingMessage').style.display = 'none';
                    document.getElementById('table').style.display = 'block';
                }
            } else {
                // No filtering needed, use current data
                filteredData = currentData;
            }
            
            // Recreate table with filtered data
            createTable(filteredData, currentDataSource);
            if (currentDataSource === 'international') {
                const hash = window.location.hash.substring(1);
                const shouldIncludeUS = hash.includes('country=US') || (!hash.includes('country=') && !hash.includes('state='));
                const totalCountries = shouldIncludeUS ? exiobaseCountries.length : exiobaseCountries.filter(c => c !== 'US').length;
                updateTotals(filteredData, currentDataSource, totalCountries);
            } else if (currentDataSource === 'combined') {
                const hash = window.location.hash.substring(1);
                const shouldIncludeUS = hash.includes('country=US') || (!hash.includes('country=') && !hash.includes('state='));
                const totalCountries = shouldIncludeUS ? exiobaseCountries.length : exiobaseCountries.filter(c => c !== 'US').length;
                updateTotals(filteredData, currentDataSource, totalCountries);
            } else {
                updateTotals(filteredData, currentDataSource);
            }
        }
        
        // Load filtered international data based on industry selection
        async function loadFilteredInternationalData() {
            const selectedYear = getSelectedYear();
            const filteredInternationalData = [];
            
            // Determine which countries to process
            const hash = window.location.hash.substring(1);
            const shouldIncludeUS = hash.includes('country=US') || (!hash.includes('country=') && !hash.includes('state='));
            const countriesToLoad = shouldIncludeUS ? 
                exiobaseCountries : 
                exiobaseCountries.filter(c => c !== 'US');
            
            console.log('Loading filtered international data for:', countriesToLoad);
            
            // Process countries in batches with industry filtering
            const batchSize = 3; // Smaller batch size for filtered loading
            for (let i = 0; i < countriesToLoad.length; i += batchSize) {
                const batch = countriesToLoad.slice(i, i + batchSize);
                console.log(`Processing filtered batch ${Math.floor(i/batchSize) + 1}:`, batch);
                
                const results = await Promise.all(batch.map(country => loadFilteredCountryData(country)));
                const validResults = results.filter(result => result !== null);
                filteredInternationalData.push(...validResults);
                
                // Small delay between batches
                if (i + batchSize < countriesToLoad.length) {
                    await new Promise(resolve => setTimeout(resolve, 300));
                }
            }
            
            // Sort by output descending
            filteredInternationalData.sort((a, b) => b.output - a.output);
            
            console.log('Successfully loaded filtered international data:', filteredInternationalData.length + ' of ' + countriesToLoad.length + ' countries');
            return filteredInternationalData;
        }
        
        // Load individual country data with industry filtering
        async function loadFilteredCountryData(countryCode) {
            try {
                const selectedYear = getSelectedYear();
                console.log(`Loading filtered data for country: ${countryCode}`);
                
                const csvPath = `${tradeData}year/${selectedYear}/${countryCode}/${selectedTradeType}/${selectedDataFile}`;
                
                const response = await fetch(csvPath);
                if (!response.ok) {
                    throw new Error(`Failed to fetch CSV for country ${countryCode}: ${response.status}`);
                }
                
                const csvText = await response.text();
                const rows = parseCSV(csvText);
                
                if (rows.length === 0) {
                    throw new Error(`No data found for country ${countryCode}`);
                }
                
                // Filter rows by industry if specific industry is selected
                let filteredRows = rows;
                
                if (selectedIndustry !== 'all') {
                    // Filter by specific industry
                    filteredRows = rows.filter(row => {
                        // Try different possible industry column names
                        return row.industry1 === selectedIndustry || 
                               row.industry2 === selectedIndustry ||
                               row.industry_id === selectedIndustry ||
                               row.industry === selectedIndustry;
                    });
                } else if (selectedCategories.length > 0) {
                    // Filter by industry categories
                    const allowedIndustries = industriesData
                        .filter(ind => selectedCategories.includes(ind.category))
                        .map(ind => ind.industry_id);
                    
                    filteredRows = rows.filter(row => {
                        // Try different possible industry column names
                        return allowedIndustries.includes(row.industry1) || 
                               allowedIndustries.includes(row.industry2) ||
                               allowedIndustries.includes(row.industry_id) ||
                               allowedIndustries.includes(row.industry);
                    });
                }
                
                console.log(`Country ${countryCode}: filtered ${rows.length} rows to ${filteredRows.length} rows`);
                
                if (filteredRows.length === 0) {
                    console.log(`No matching industry data for ${countryCode}`);
                    return null;
                }
                
                // Aggregate filtered data
                let totals = {};
                let transactionCount = 0;
                
                filteredRows.forEach(row => {
                    if (row.amount && !isNaN(parseFloat(row.amount))) {
                        Object.keys(row).forEach(key => {
                            const value = parseFloat(row[key]);
                            if (!isNaN(value)) {
                                totals[key] = (totals[key] || 0) + value;
                            }
                        });
                        transactionCount++;
                    }
                });
                
                // Create result object - scale raw values to correct units
                const rawOutput = totals.amount || 0;
                const rawEmployment = totals.Employment_total || 0;
                
                // Scale adjustments based on debug analysis and data source investigation
                // Output: CSV values are in millions, scale to trillions
                // Employment: CSV has unit mixing bug causing ~1000x inflation, scale down accordingly
                const scaledOutput = rawOutput * 1000000; // Scale millions to trillions
                const scaledEmployment = rawEmployment / 1000; // Fix trade_impact.py unit mixing bug (~1000x inflation)
                
                console.log(`Filtered country ${countryCode} raw values:`, { rawOutput, rawEmployment });
                console.log(`Filtered country ${countryCode} scaled values:`, { scaledOutput, scaledEmployment });
                
                const result = {
                    country: countryCode,
                    countryName: countryNames[countryCode] || countryCode,
                    output: scaledOutput, // Store scaled value
                    outputFormatted: formatCurrency(scaledOutput),
                    employment: scaledEmployment, // Store scaled value
                    employmentFormatted: formatEmployment(scaledEmployment),
                    transactionCount: transactionCount,
                    type: 'country',
                    filtered: true // Mark as filtered data
                };
                
                // Add environmental metrics with appropriate scaling
                const keyMetrics = ['CO2_total', 'Energy_total', 'Water_total', 'Land_total', 'CH4_total', 'N2O_total', 'NOX_total'];
                keyMetrics.forEach(metric => {
                    if (totals[metric] !== undefined) {
                        // Environmental metrics may need scaling too - using 1000x for now
                        const scaledMetric = (totals[metric] || 0) * 1000;
                        result[metric] = scaledMetric;
                        result[metric + '_formatted'] = formatNumber(scaledMetric);
                    }
                });
                
                // For US, add all available data columns
                if (countryCode === 'US') {
                    Object.keys(totals).forEach(key => {
                        if (!result[key] && key !== 'amount') {
                            result[key] = Math.round(totals[key] || 0);
                            result[key + '_formatted'] = formatNumber(Math.round(totals[key] || 0));
                        }
                    });
                    result.allColumns = Object.keys(totals);
                    result.allData = totals;
                }
                
                return result;
                
            } catch (error) {
                console.error(`Error loading filtered country ${countryCode}:`, error);
                return null;
            }
        }
        
        // Update URL hash with filter values
        function updateHashWithFilters() {
            const hash = window.location.hash.substring(1);
            const hashParams = new URLSearchParams(hash.replace(/&/g, '&').replace(/=/g, '='));
            
            // Update category filter in hash
            if (selectedCategories.length > 0) {
                hashParams.set('categories', selectedCategories.join(','));
            } else {
                hashParams.delete('categories');
            }
            
            // Update industry filter in hash
            if (selectedIndustry && selectedIndustry !== 'all') {
                hashParams.set('industry', selectedIndustry);
            } else {
                hashParams.delete('industry');
            }
            
            // Reconstruct hash
            const newHashParams = hashParams.toString();
            const newHash = newHashParams.replace(/&/g, '&').replace(/=/g, '=');
            
            // Update URL without triggering hashchange event
            if (window.location.hash !== '#' + newHash) {
                history.replaceState(null, null, '#' + newHash);
            }
        }
        
        // Save filter values to browser cache
        function saveFiltersToCache() {
            const filters = {
                categories: selectedCategories,
                industry: selectedIndustry
            };
            localStorage.setItem('industryFilters', JSON.stringify(filters));
        }
        
        // Load filter values from browser cache or URL hash
        function loadFiltersFromCache() {
            // First check URL hash
            const hash = window.location.hash.substring(1);
            const hashParams = new URLSearchParams(hash.replace(/&/g, '&').replace(/=/g, '='));
            
            const categoriesFromHash = hashParams.get('categories');
            const industryFromHash = hashParams.get('industry');
            
            if (categoriesFromHash || industryFromHash) {
                // Use values from URL hash
                selectedCategories = categoriesFromHash ? categoriesFromHash.split(',') : [];
                selectedIndustry = industryFromHash || 'all';
            } else {
                // Fallback to localStorage
                try {
                    const savedFilters = localStorage.getItem('industryFilters');
                    if (savedFilters) {
                        const filters = JSON.parse(savedFilters);
                        selectedCategories = filters.categories || [];
                        selectedIndustry = filters.industry || 'all';
                    }
                } catch (error) {
                    console.error('Error loading filters from cache:', error);
                }
            }
        }
        
        // Apply loaded filter values to UI
        function applyLoadedFilters() {
            // Update category checkboxes
            selectedCategories.forEach(category => {
                // Find checkbox by iterating through all checkboxes to avoid CSS selector issues
                const checkboxes = document.querySelectorAll('#categoryPopup input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    if (checkbox.value === category) {
                        checkbox.checked = true;
                    }
                });
            });
            
            // Update category display
            const categoryDisplay = document.getElementById('categoryDisplay');
            if (selectedCategories.length === 0) {
                categoryDisplay.textContent = 'All Categories';
            } else if (selectedCategories.length === 1) {
                categoryDisplay.textContent = selectedCategories[0];
            } else {
                categoryDisplay.textContent = `${selectedCategories.length} Categories`;
            }
            
            // Update industry dropdown
            populateIndustryDropdown();
            
            const industryDropdown = document.getElementById('industry');
            if (selectedIndustry && selectedIndustry !== 'all') {
                industryDropdown.value = selectedIndustry;
            }
        }
        
        // Show/hide industry filter based on data source
        function updateIndustryFilterVisibility() {
            const filterContainer = document.getElementById('industryFilterContainer');
            
            // Show industry filter for international and combined views only
            if (currentDataSource === 'international' || currentDataSource === 'combined') {
                filterContainer.style.display = 'block';
            } else {
                filterContainer.style.display = 'none';
            }
        }
        
        // Trade data path configuration
        //const tradeData = "../../trade-data/";
        const tradeData = "https://raw.githubusercontent.com/ModelEarth/trade-data/refs/heads/main/";
        const tradeDataDisplay = "trade-data/"; // Shortened path for display

        // Country code to name mapping for international data
        const countryNames = {
            'US': 'United States',
            'CN': 'China',
            'DE': 'Germany',
            'FR': 'France', 
            'GB': 'United Kingdom',
            'IN': 'India',
            'JP': 'Japan',
            'IT': 'Italy',
            'BR': 'Brazil',
            'CA': 'Canada',
            'RU': 'Russia',
            'MX': 'Mexico',
            'KR': 'South Korea',
            'AU': 'Australia',
            'ES': 'Spain',
            'NL': 'Netherlands',
            'WM': 'Middle East (row)',
            'SA': 'Saudi Arabia',
            'ZA': 'South Africa'
        };
        
        // State mapping - All 50 US states
        const stateMapping = {
            'AK': 'Alaska',
            'AL': 'Alabama',
            'AR': 'Arkansas',
            'AZ': 'Arizona',
            'CA': 'California',
            'CO': 'Colorado',
            'CT': 'Connecticut',
            'DE': 'Delaware',
            'FL': 'Florida',
            'GA': 'Georgia',
            'HI': 'Hawaii',
            'IA': 'Iowa',
            'ID': 'Idaho',
            'IL': 'Illinois',
            'IN': 'Indiana',
            'KS': 'Kansas',
            'KY': 'Kentucky',
            'LA': 'Louisiana',
            'MA': 'Massachusetts',
            'MD': 'Maryland',
            'ME': 'Maine',
            'MI': 'Michigan',
            'MN': 'Minnesota',
            'MO': 'Missouri',
            'MS': 'Mississippi',
            'MT': 'Montana',
            'NC': 'North Carolina',
            'ND': 'North Dakota',
            'NE': 'Nebraska',
            'NH': 'New Hampshire',
            'NJ': 'New Jersey',
            'NM': 'New Mexico',
            'NV': 'Nevada',
            'NY': 'New York',
            'OH': 'Ohio',
            'OK': 'Oklahoma',
            'OR': 'Oregon',
            'PA': 'Pennsylvania',
            'RI': 'Rhode Island',
            'SC': 'South Carolina',
            'SD': 'South Dakota',
            'TN': 'Tennessee',
            'TX': 'Texas',
            'UT': 'Utah',
            'VA': 'Virginia',
            'VT': 'Vermont',
            'WA': 'Washington',
            'WI': 'Wisconsin',
            'WV': 'West Virginia',
            'WY': 'Wyoming'
        };
        
        // Available countries in Exiobase data
        const exiobaseCountries = ['US', 'CN', 'DE', 'JP', 'GB', 'CA', 'AU', 'IT', 'KR', 'FR', 'BR', 'IN', 'WM', 'SA', 'ZA'];
        
        // Utility functions
        function formatNumber(num) {
            if (num >= 1e12) {
                return (num / 1e12).toFixed(1) + ' Trillion';
            } else if (num >= 1e9) {
                return (num / 1e9).toFixed(1) + ' Billion';
            } else if (num >= 1e6) {
                return (num / 1e6).toFixed(1) + ' Million';
            } else if (num >= 1e3) {
                return (num / 1e3).toFixed(1) + 'K';
            }
            return num.toFixed(0);
        }
        
        function formatCurrency(num) {
            if (num >= 1e12) {
                return '$' + (num / 1e12).toFixed(1) + ' Trillion';
            } else if (num >= 1e9) {
                return '$' + (num / 1e9).toFixed(1) + ' Billion';
            } else if (num >= 1e6) {
                return '$' + (num / 1e6).toFixed(1) + ' Million';
            } else if (num >= 1e3) {
                return '$' + (num / 1e3).toFixed(1) + 'K';
            }
            return '$' + num.toFixed(0);
        }
        
        // Special formatter for employment numbers (3 decimal places for billions)
        function formatEmployment(num) {
            if (num >= 1e12) {
                return (num / 1e12).toFixed(1) + ' Trillion';
            } else if (num >= 1e9) {
                return (num / 1e9).toFixed(3) + ' Billion';
            } else if (num >= 1e6) {
                return (num / 1e6).toFixed(1) + ' Million';
            } else if (num >= 1e3) {
                return (num / 1e3).toFixed(1) + 'K';
            }
            return num.toFixed(0);
        }
        
        // Check if local USEEIO data is available
        async function checkLocalUseeioAvailability() {
            if (useLocalUseeio !== null) {
                return useLocalUseeio; // Already checked
            }
            
            try {
                // Check for local models.json file
                const response = await fetch('../../useeio-json/models/2020/models.json');
                useLocalUseeio = response.ok;
                
                const source = useLocalUseeio ? 'local useeio-json directory' : 'GitHub repository (modelearth/useeio-json)';
                console.log(`USEEIO data source: ${source}`);
                
                // Show message on localhost only (once)
                if (!useeioSourceMessageShown && window.location.hostname === 'localhost') {
                    showUseeioSourceMessage(source);
                    useeioSourceMessageShown = true;
                }
                
                return useLocalUseeio;
            } catch (error) {
                console.log('USEEIO data source: GitHub repository (modelearth/useeio-json) - local check failed');
                useLocalUseeio = false;
                
                if (!useeioSourceMessageShown && window.location.hostname === 'localhost') {
                    showUseeioSourceMessage('GitHub repository (modelearth/useeio-json)');
                    useeioSourceMessageShown = true;
                }
                
                return false;
            }
        }
        
        // Show USEEIO source message below chart (localhost only)
        function showUseeioSourceMessage(source) {
            const existingMessage = document.getElementById('useeioSourceMessage');
            if (existingMessage) {
                return; // Message already shown
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.id = 'useeioSourceMessage';
            messageDiv.style.cssText = `
                margin: 15px 0;
                padding: 10px;
                background-color: #e3f2fd;
                border: 1px solid #2196f3;
                border-radius: 4px;
                font-size: 0.9em;
                color: #1976d2;
                text-align: center;
            `;
            messageDiv.innerHTML = `<strong>USEEIO Data Source:</strong> ${source}`;
            
            // Insert after the main table
            const tableDiv = document.getElementById('table');
            tableDiv.parentNode.insertBefore(messageDiv, tableDiv.nextSibling);
        }
        
        // Load US state data from USEEIO.js models
        async function loadUSStateData() {
            try {
                // Check data source availability first
                const isLocalAvailable = await checkLocalUseeioAvailability();
                
                // Check URL hash for specific state filtering
                const hash = window.location.hash.substring(1);
                const stateMatch = hash.match(/state=([^&]*)/);
                const stateParam = stateMatch ? stateMatch[1] : null;
                
                let statesToLoad;
                if (stateParam && stateParam !== 'all') {
                    // Handle comma-separated states (e.g., CA,TX,NY)
                    const requestedStates = stateParam.split(',').map(s => s.trim().toUpperCase());
                    const validStates = requestedStates.filter(state => stateMapping[state]);
                    
                    if (validStates.length > 0) {
                        statesToLoad = validStates;
                        
                        // Update description based on number of states
                        if (validStates.length === 1) {
                            updateDataInfo(`${stateMapping[validStates[0]]} state economic output and employment data from USEEIO models`);
                        } else if (validStates.length <= 5) {
                            const stateNames = validStates.map(state => stateMapping[state]).join(', ');
                            updateDataInfo(`${stateNames} state economic output and employment data from USEEIO models`);
                        } else {
                            updateDataInfo(`${validStates.length} selected US states economic output and employment data from USEEIO models`);
                        }
                        
                        console.log('Loading specific states:', validStates, 'from param:', stateParam);
                    } else {
                        // No valid states found, load all
                        statesToLoad = Object.keys(stateMapping);
                        updateDataInfo('US state-level economic output and employment data from USEEIO models');
                        console.log('No valid states found in param:', stateParam, 'loading all states');
                    }
                } else {
                    // Load all 50 states
                    statesToLoad = Object.keys(stateMapping);
                    updateDataInfo('US state-level economic output and employment data from USEEIO models');
                }
                
                const batchSize = 5; // Process in batches
                usStateData = [];
                
                console.log('Loading US state data for:', statesToLoad);
                console.log('Using USEEIO source:', isLocalAvailable ? 'local' : 'GitHub');
                
                // Process states in batches (similar to useeio.js/footprint/states.html)
                for (let i = 0; i < statesToLoad.length; i += batchSize) {
                    const batch = statesToLoad.slice(i, i + batchSize);
                    console.log(`Processing batch ${Math.floor(i/batchSize) + 1}:`, batch);
                    
                    const results = await Promise.all(batch.map(state => loadStateData(state)));
                    const validResults = results.filter(result => result !== null);
                    usStateData.push(...validResults);
                    
                    // Small delay between batches
                    if (i + batchSize < statesToLoad.length) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }
                
                // Sort by output descending
                usStateData.sort((a, b) => b.output - a.output);
                
                // Update data sources display with actual paths and files used
                const statePaths = [];
                usStateData.forEach(stateData => {
                    if (stateData.stateAbbr) {
                        const isLocalAvailable = useLocalUseeio;
                        const rawPath = isLocalAvailable ? 
                            `/useeio-json/models/2020/${stateData.stateAbbr}EEIOv1.0-s-20/` :
                            `https://raw.githubusercontent.com/modelearth/useeio-json/refs/heads/main/models/2020/${stateData.stateAbbr}EEIOv1.0-s-20/`;
                        
                        // For parent row links, use GitHub tree view instead of raw
                        const modelDir = isLocalAvailable ? 
                            rawPath :
                            `https://github.com/ModelEarth/useeio-json/tree/main/models/2020/${stateData.stateAbbr}EEIOv1.0-s-20`;
                        
                        statePaths.push({
                            label: `${stateData.stateName} (${stateData.stateAbbr}) - Model Directory`,
                            path: modelDir,
                            displayPath: `2020/${stateData.stateAbbr}EEIOv1.0-s-20`,
                            type: 'useeio',
                            isLink: true,
                            isParent: true,
                            stateId: stateData.stateAbbr
                        });
                        // Add links to specific files used
                        const keyFiles = ['sectors.json', 'indicators.json', 'matrix/q.json', 'matrix/D.json'];
                        keyFiles.forEach(file => {
                            statePaths.push({
                                label: `${file}`,
                                path: rawPath + file, // Use raw path for file downloads
                                displayPath: `2020/${stateData.stateAbbr}EEIOv1.0-s-20/${file}`,
                                type: 'useeio-file',
                                isLink: true,
                                isChild: true,
                                parentId: stateData.stateAbbr
                            });
                        });
                    }
                });
                updateDataSources('us', statePaths);
                
                console.log('Successfully loaded US state data:', usStateData.length + ' states');
                return usStateData;
                
            } catch (error) {
                console.error('Error loading US state data:', error);
                // Fall back to simulated data if real data fails
                const fallbackData = await loadSimulatedUSStateData();
                
                // Update data sources for fallback
                const fallbackPaths = [{
                    label: 'US States (Simulated Data)',
                    path: 'Fallback data - USEEIO models unavailable',
                    type: 'fallback',
                    isLink: false
                }];
                updateDataSources('us', fallbackPaths);
                
                return fallbackData;
            }
        }
        
        // Load individual state data using USEEIO.js
        async function loadStateData(stateCode) {
            try {
                console.log(`Loading data for state: ${stateCode}`);
                
                // Determine endpoint based on availability check
                const isLocalAvailable = await checkLocalUseeioAvailability();
                const endpoint = isLocalAvailable ? 
                    '../../useeio-json/models/2020' : 
                    'https://raw.githubusercontent.com/modelearth/useeio-json/refs/heads/main/models/2020';
                
                const modelParams = {
                    endpoint: endpoint,
                    asJsonFiles: true,
                    model: `${stateCode}EEIOv1.0-s-20`
                };
                
                console.log(`Loading ${stateCode} from:`, endpoint);
                
                const model = await useeio.modelOf(modelParams);
                if (!model) {
                    throw new Error(`Failed to get model for state ${stateCode}`);
                }
                
                // Get required data
                const sectors = await model.sectors();
                const qMatrix = await model.matrix("q"); // Output matrix
                const dMatrix = await model.matrix("D"); // Direct requirements matrix
                const indicators = await model.indicators();
                const jobs = indicators.find(i => i.code === "JOBS");
                
                if (!jobs) {
                    throw new Error("Could not find jobs indicator");
                }
                
                // Filter sectors for this state and calculate totals
                const stateSectors = sectors.filter(s => s.location === `US-${stateCode}`);
                let totalOutput = 0;
                let totalJobs = 0;
                
                stateSectors.forEach(sector => {
                    const output = qMatrix.get(sector.index, 0) || 0;
                    const jobsPerDollar = dMatrix.get(jobs.index, sector.index) || 0;
                    const jobCount = output * jobsPerDollar;
                    
                    totalOutput += output;
                    totalJobs += jobCount;
                });
                
                console.log(`State ${stateCode} data:`, { output: totalOutput, jobs: totalJobs });
                
                console.log(`State ${stateCode} raw values:`, { totalOutput, totalJobs });
                
                return {
                    state: stateCode,
                    stateName: stateMapping[stateCode],
                    stateAbbr: stateCode,
                    output: totalOutput, // Store raw value
                    outputFormatted: formatCurrency(totalOutput),
                    employment: totalJobs, // Store raw value
                    employmentFormatted: formatEmployment(totalJobs),
                    type: 'state'
                };
                
            } catch (error) {
                console.error(`Error loading state ${stateCode}:`, error);
                return null;
            }
        }
        
        // Fallback simulated data if real data fails
        async function loadSimulatedUSStateData() {
            console.log('Falling back to simulated US state data');
            const simulatedData = [
                { state: 'CA', stateName: 'California', stateAbbr: 'CA', output: 2500000000000, employment: 18500000, type: 'state' },
                { state: 'TX', stateName: 'Texas', stateAbbr: 'TX', output: 1800000000000, employment: 13200000, type: 'state' },
                { state: 'NY', stateName: 'New York', stateAbbr: 'NY', output: 1600000000000, employment: 9500000, type: 'state' },
                { state: 'FL', stateName: 'Florida', stateAbbr: 'FL', output: 900000000000, employment: 9200000, type: 'state' },
                { state: 'IL', stateName: 'Illinois', stateAbbr: 'IL', output: 750000000000, employment: 6100000, type: 'state' },
                { state: 'PA', stateName: 'Pennsylvania', stateAbbr: 'PA', output: 720000000000, employment: 6000000, type: 'state' },
                { state: 'OH', stateName: 'Ohio', stateAbbr: 'OH', output: 650000000000, employment: 5400000, type: 'state' },
                { state: 'GA', stateName: 'Georgia', stateAbbr: 'GA', output: 520000000000, employment: 4700000, type: 'state' },
                { state: 'NC', stateName: 'North Carolina', stateAbbr: 'NC', output: 500000000000, employment: 4600000, type: 'state' },
                { state: 'NJ', stateName: 'New Jersey', stateAbbr: 'NJ', output: 580000000000, employment: 4200000, type: 'state' }
            ];
            
            // Add formatted values
            simulatedData.forEach(row => {
                row.outputFormatted = formatCurrency(row.output);
                row.employmentFormatted = formatNumber(row.employment);
            });
            
            return simulatedData;
        }
        
        // Load international data from Exiobase CSV files
        async function loadInternationalData() {
            try {
                const selectedYear = getSelectedYear();
                updateDataInfo(`International trade flow data from Exiobase MRIO database (${selectedYear})`);
                
                // Check if we should include US data based on URL hash
                const hash = window.location.hash.substring(1);
                const shouldIncludeUS = hash.includes('country=US') || (!hash.includes('country=') && !hash.includes('state='));
                
                // Countries to process - include US if specifically requested
                const countriesToLoad = shouldIncludeUS ? 
                    exiobaseCountries : 
                    exiobaseCountries.filter(c => c !== 'US');
                internationalData = [];
                
                console.log('Loading international data for:', countriesToLoad);
                
                // Process countries in smaller batches
                const batchSize = 4;
                for (let i = 0; i < countriesToLoad.length; i += batchSize) {
                    const batch = countriesToLoad.slice(i, i + batchSize);
                    console.log(`Processing international batch ${Math.floor(i/batchSize) + 1}:`, batch);
                    
                    const results = await Promise.all(batch.map(country => loadCountryData(country)));
                    const validResults = results.filter(result => result !== null);
                    internationalData.push(...validResults);
                    
                    // Small delay between batches
                    if (i + batchSize < countriesToLoad.length) {
                        await new Promise(resolve => setTimeout(resolve, 200));
                    }
                }
                
                // Sort by output descending
                internationalData.sort((a, b) => b.output - a.output);
                
                // Calculate availability stats
                const totalCountriesToLoad = countriesToLoad.length;
                const successfullyLoaded = internationalData.length;
                
                console.log(`Loaded ${successfullyLoaded} of ${totalCountriesToLoad} countries`);
                
                // Update data sources display with actual paths used
                const countryPaths = [];
                internationalData.forEach(countryData => {
                    if (countryData.country) {
                        countryPaths.push({
                            label: `${countryData.countryName} (${countryData.country})`,
                            path: `${tradeData}year/${selectedYear}/${countryData.country}/${selectedTradeType}/${selectedDataFile}`,
                            displayPath: `year/${selectedYear}/${countryData.country}/${selectedTradeType}/${selectedDataFile}`,
                            type: 'exiobase',
                            isLink: true,
                            isCountryPath: true // Special flag for country path styling
                        });
                    }
                });
                updateDataSources('international', countryPaths);
                
                console.log('Successfully loaded international data:', internationalData.length + ' countries');
                return internationalData;
                
            } catch (error) {
                console.error('Error loading international data:', error);
                // Fall back to simulated data if real data fails
                const fallbackData = await loadSimulatedInternationalData();
                
                // Update data sources for fallback
                const fallbackPaths = [{
                    label: 'International (Simulated Data)',
                    path: 'Fallback data - Exiobase CSV files unavailable',
                    type: 'fallback',
                    isLink: false
                }];
                updateDataSources('international', fallbackPaths);
                
                return fallbackData;
            }
        }
        
        // Load individual country data from Exiobase CSV
        async function loadCountryData(countryCode) {
            try {
                const selectedYear = getSelectedYear();
                console.log(`Loading data for country: ${countryCode}, year: ${selectedYear}, trade type: ${selectedTradeType}, file: ${selectedDataFile}`);
                
                // Use the selected year, trade type and data file
                const csvPath = `${tradeData}year/${selectedYear}/${countryCode}/${selectedTradeType}/${selectedDataFile}`;
                
                const response = await fetch(csvPath);
                if (!response.ok) {
                    throw new Error(`Failed to fetch CSV for country ${countryCode}: ${response.status}`);
                }
                
                const csvText = await response.text();
                const rows = parseCSV(csvText);
                
                if (rows.length === 0) {
                    throw new Error(`No data found for country ${countryCode}`);
                }
                
                // For US specifically, capture all available columns
                if (countryCode === 'US') {
                    console.log(`Available columns for ${countryCode}:`, Object.keys(rows[0] || {}));
                    console.log(`Sample row for ${countryCode}:`, rows[0]);
                }
                
                // Aggregate data by summing all trade flows
                let totals = {};
                let transactionCount = 0;
                
                rows.forEach(row => {
                    // Skip header row and invalid data
                    if (row.amount && !isNaN(parseFloat(row.amount))) {
                        // For each numeric column, add to totals
                        Object.keys(row).forEach(key => {
                            const value = parseFloat(row[key]);
                            if (!isNaN(value)) {
                                totals[key] = (totals[key] || 0) + value;
                            }
                        });
                        transactionCount++;
                    }
                });
                
                console.log(`Country ${countryCode} data totals:`, totals);
                
                // Create base result object - scale raw values to correct units
                const rawOutput = totals.amount || 0;
                const rawEmployment = totals.Employment_total || 0;
                
                // Scale adjustments based on debug analysis and data source investigation
                // Output: CSV values are in millions, scale to trillions
                // Employment: CSV has unit mixing bug causing ~1000x inflation, scale down accordingly
                const scaledOutput = rawOutput * 1000000; // Scale millions to trillions
                const scaledEmployment = rawEmployment / 1000; // Fix trade_impact.py unit mixing bug (~1000x inflation)
                
                console.log(`Country ${countryCode} raw values:`, { rawOutput, rawEmployment });
                console.log(`Country ${countryCode} scaled values:`, { scaledOutput, scaledEmployment });
                
                const result = {
                    country: countryCode,
                    countryName: countryNames[countryCode] || countryCode,
                    output: scaledOutput, // Store scaled value
                    outputFormatted: formatCurrency(scaledOutput),
                    employment: scaledEmployment, // Store scaled value
                    employmentFormatted: formatEmployment(scaledEmployment),
                    transactionCount: transactionCount,
                    type: 'country'
                };
                
                // Add key environmental metrics for all countries
                const keyMetrics = ['CO2_total', 'Energy_total', 'Water_total', 'Land_total', 'CH4_total', 'N2O_total', 'NOX_total'];
                keyMetrics.forEach(metric => {
                    if (totals[metric] !== undefined) {
                        result[metric] = Math.round(totals[metric] || 0);
                        result[metric + '_formatted'] = formatNumber(Math.round(totals[metric] || 0));
                    }
                });
                
                // For US, add all available data columns and mark for extended display
                if (countryCode === 'US') {
                    Object.keys(totals).forEach(key => {
                        if (!result[key] && key !== 'amount') {
                            result[key] = totals[key] || 0; // Store raw value
                            result[key + '_formatted'] = formatNumber(totals[key] || 0);
                        }
                    });
                    
                    // Store all columns for potential table display
                    result.allColumns = Object.keys(totals);
                    result.allData = totals;
                }
                
                return result;
                
            } catch (error) {
                console.error(`Error loading country ${countryCode}:`, error);
                return null;
            }
        }
        
        // Simple CSV parser for Exiobase data
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) return [];
            
            const headers = lines[0].split(',').map(h => h.trim());
            const rows = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                if (values.length >= headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] ? values[index].trim() : '';
                    });
                    rows.push(row);
                }
            }
            
            return rows;
        }
        
        // Fallback simulated data if real data fails
        async function loadSimulatedInternationalData() {
            console.log('Falling back to simulated international data');
            const simulatedData = [
                { country: 'CN', countryName: 'China', output: 14000000000000, employment: 780000000, type: 'country' },
                { country: 'JP', countryName: 'Japan', output: 5000000000000, employment: 67000000, type: 'country' },
                { country: 'DE', countryName: 'Germany', output: 4000000000000, employment: 45000000, type: 'country' },
                { country: 'IN', countryName: 'India', output: 3000000000000, employment: 520000000, type: 'country' },
                { country: 'GB', countryName: 'United Kingdom', output: 2800000000000, employment: 33000000, type: 'country' },
                { country: 'FR', countryName: 'France', output: 2700000000000, employment: 29000000, type: 'country' },
                { country: 'IT', countryName: 'Italy', output: 2000000000000, employment: 26000000, type: 'country' },
                { country: 'BR', countryName: 'Brazil', output: 1800000000000, employment: 95000000, type: 'country' },
                { country: 'CA', countryName: 'Canada', output: 1700000000000, employment: 19500000, type: 'country' },
                { country: 'AU', countryName: 'Australia', output: 1400000000000, employment: 12800000, type: 'country' },
                { country: 'KR', countryName: 'South Korea', output: 1600000000000, employment: 27000000, type: 'country' }
            ];
            
            // Add formatted values
            simulatedData.forEach(row => {
                row.outputFormatted = formatCurrency(row.output);
                row.employmentFormatted = formatNumber(row.employment);
            });
            
            return simulatedData;
        }
        
        // Load combined data (states + countries, excluding US country row)
        async function loadCombinedData() {
            try {
                updateDataInfo('Combined US state-level and international country data for comparison');
                
                // Ensure both datasets are loaded
                if (usStateData.length === 0) {
                    await loadUSStateData();
                }
                if (internationalData.length === 0) {
                    await loadInternationalData();
                }
                
                // Combine data (US country is already excluded from international data)
                combinedData = [...usStateData, ...internationalData];
                
                // Update data sources display for combined view with actual paths
                const combinedPaths = [];
                
                // Add US state paths
                usStateData.forEach(stateData => {
                    if (stateData.stateAbbr) {
                        const isLocalAvailable = useLocalUseeio;
                        const rawPath = isLocalAvailable ? 
                            `/useeio-json/models/2020/${stateData.stateAbbr}EEIOv1.0-s-20/` :
                            `https://raw.githubusercontent.com/modelearth/useeio-json/refs/heads/main/models/2020/${stateData.stateAbbr}EEIOv1.0-s-20/`;
                        
                        // For parent row links, use GitHub tree view instead of raw
                        const modelDir = isLocalAvailable ? 
                            rawPath :
                            `https://github.com/ModelEarth/useeio-json/tree/main/models/2020/${stateData.stateAbbr}EEIOv1.0-s-20`;
                        
                        combinedPaths.push({
                            label: `${stateData.stateName} (${stateData.stateAbbr}) - Model Directory`,
                            path: modelDir,
                            displayPath: `2020/${stateData.stateAbbr}EEIOv1.0-s-20`,
                            type: 'useeio',
                            isLink: true,
                            isParent: true,
                            stateId: stateData.stateAbbr
                        });
                        // Add links to specific files used
                        const keyFiles = ['sectors.json', 'indicators.json', 'matrix/q.json', 'matrix/D.json'];
                        keyFiles.forEach(file => {
                            combinedPaths.push({
                                label: `${file}`,
                                path: rawPath + file, // Use raw path for file downloads
                                displayPath: `2020/${stateData.stateAbbr}EEIOv1.0-s-20/${file}`,
                                type: 'useeio-file',
                                isLink: true,
                                isChild: true,
                                parentId: stateData.stateAbbr
                            });
                        });
                    }
                });
                
                // Add international country paths
                const selectedYear = getSelectedYear();
                internationalData.forEach(countryData => {
                    if (countryData.country) {
                        combinedPaths.push({
                            label: `${countryData.countryName} (${countryData.country})`,
                            path: `${tradeData}year/${selectedYear}/${countryData.country}/${selectedTradeType}/${selectedDataFile}`,
                            displayPath: `year/${selectedYear}/${countryData.country}/${selectedTradeType}/${selectedDataFile}`,
                            type: 'exiobase',
                            isLink: true,
                            isCountryPath: true // Special flag for country path styling
                        });
                    }
                });
                
                updateDataSources('combined', combinedPaths);
                
                console.log('Loaded combined data:', combinedData.length + ' regions (states + countries)');
                return combinedData;
                
            } catch (error) {
                console.error('Error loading combined data:', error);
                return [];
            }
        }
        
        // Update data information display
        function updateDataInfo(description) {
            document.getElementById('dataDescription').textContent = description;
        }
        
        // Update data description based on selected file and trade type
        function updateDataDescription() {
            const fileSelector = document.getElementById('fileSelector');
            const tradeTypeSelector = document.getElementById('tradeTypeSelector');
            const selectedFileOption = fileSelector.options[fileSelector.selectedIndex];
            const selectedTradeOption = tradeTypeSelector.options[tradeTypeSelector.selectedIndex];
            const fileName = selectedFileOption.text;
            const tradeTypeName = selectedTradeOption.text;
            
            if (currentDataSource === 'international') {
                updateDataInfo(`${tradeTypeName} data from ${fileName} across countries`);
            } else if (currentDataSource === 'combined') {
                updateDataInfo(`Combined US state and ${tradeTypeName.toLowerCase()} data from ${fileName}`);
            }
        }
        
        // Update file options based on trade type
        function updateFileOptions() {
            const fileSelector = document.getElementById('fileSelector');
            const currentValue = fileSelector.value;
            
            // Clear existing options
            fileSelector.innerHTML = '';
            
            // Define available files for each trade type
            const fileOptions = {
                domestic: [
                    {value: 'trade_impact.csv', text: 'Environmental Impacts (trade_impact.csv)'},
                    {value: 'trade_employment.csv', text: 'Employment Data (trade_employment.csv)'},
                    {value: 'trade_factor.csv', text: 'Environmental Factors (trade_factor.csv)'},
                    {value: 'trade_material.csv', text: 'Material Flows (trade_material.csv)'},
                    {value: 'trade_resource.csv', text: 'Resource Usage (trade_resource.csv)'},
                    {value: 'trade.csv', text: 'Industry Flow Data (trade.csv)'}
                ],
                imports: [
                    {value: 'trade_impact.csv', text: 'Environmental Impacts (trade_impact.csv)'},
                    {value: 'trade_factor.csv', text: 'Environmental Factors (trade_factor.csv)'},
                    {value: 'trade_resource.csv', text: 'Resource Usage (trade_resource.csv)'},
                    {value: 'trade.csv', text: 'Industry Flow Data (trade.csv)'},
                ],
                exports: [
                    {value: 'trade_impact.csv', text: 'Environmental Impacts (trade_impact.csv)'},
                    {value: 'trade_employment.csv', text: 'Employment Data (trade_employment.csv)'},
                    {value: 'trade_factor.csv', text: 'Environmental Factors (trade_factor.csv)'},
                    {value: 'trade_material.csv', text: 'Material Flows (trade_material.csv)'},
                    {value: 'trade_resource.csv', text: 'Resource Usage (trade_resource.csv)'},
                    {value: 'trade.csv', text: 'Industry Flow Data (trade.csv)'}
                ]
            };
            
            // Add options for selected trade type
            const options = fileOptions[selectedTradeType] || fileOptions.domestic;
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option.value;
                optionElement.textContent = option.text;
                fileSelector.appendChild(optionElement);
            });
            
            // Try to maintain previous selection if available
            if (currentValue && [...fileSelector.options].some(opt => opt.value === currentValue)) {
                fileSelector.value = currentValue;
                selectedDataFile = currentValue;
            } else {
                // Default to first option
                selectedDataFile = fileSelector.value;
            }
        }
        
        // Show/hide file selector based on hash
        function updateFileSelector() {
            const hash = window.location.hash.substring(1);
            const fileContainer = document.getElementById('fileSelectionContainer');
            
            // Show file selector only for specific country views in international mode
            if (hash.startsWith('country=') && currentDataSource === 'international') {
                const countryCode = hash.split('=')[1];
                if (countryCode && countryCode !== 'all' && countryCode.length === 2) {
                    fileContainer.style.display = 'block';
                    updateFileOptions(); // Update available files
                    updateDataDescription();
                    return;
                }
            }
            
            // Hide file selector for other views
            fileContainer.style.display = 'none';
        }
        
        // Update data sources display
        function updateDataSources(dataType, paths = []) {
            const container = document.getElementById('dataSourcesContainer');
            const pathsDiv = document.getElementById('dataSourcesPaths');
            
            // Clear previous paths
            pathsDiv.innerHTML = '';
            
            if (paths.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            // Add paths based on data type
            paths.forEach(pathInfo => {
                const pathDiv = document.createElement('div');
                let pathClass = `data-path ${pathInfo.type || ''}`;
                
                // Add parent/child classes
                if (pathInfo.isParent) {
                    pathClass += ' parent-row';
                } else if (pathInfo.isChild) {
                    pathClass += ' child-row hidden'; // Start hidden
                    pathDiv.setAttribute('data-parent', pathInfo.parentId);
                }
                
                pathDiv.className = pathClass;
                
                const label = document.createElement('span');
                label.className = 'data-path-label';
                
                // Add expand arrow for parent rows
                if (pathInfo.isParent) {
                    const arrow = document.createElement('i');
                    arrow.className = 'expand-arrow ph ph-caret-right';
                    arrow.onclick = (e) => {
                        e.stopPropagation();
                        toggleSubRows(pathInfo.stateId || pathInfo.parentId, arrow);
                    };
                    label.appendChild(arrow);
                }
                
                const labelText = document.createElement('span');
                labelText.textContent = pathInfo.label + ':';
                label.appendChild(labelText);
                
                const pathContainer = document.createElement('span');
                pathContainer.style.display = 'block';
                
                if (pathInfo.isParent || pathInfo.isCountryPath) {
                    // For parent rows and country paths: show path in grey text with small link icon
                    pathContainer.style.pointerEvents = 'none'; // Allow clicks to pass through for parent rows
                    
                    const pathText = document.createElement('span');
                    pathText.textContent = pathInfo.displayPath || pathInfo.path;
                    pathText.style.color = '#666';
                    pathText.style.fontSize = '0.9em';
                    pathText.style.pointerEvents = 'none';
                    
                    if (pathInfo.isLink && pathInfo.path) {
                        const linkIcon = document.createElement('a');
                        linkIcon.href = pathInfo.path;
                        linkIcon.target = '_blank';
                        linkIcon.innerHTML = '<i class="ph ph-arrow-square-out" style="font-size: 1.1em; margin-left: 8px;"></i>';
                        linkIcon.style.color = '#007bff';
                        linkIcon.style.textDecoration = 'none';
                        linkIcon.style.pointerEvents = 'auto'; // Enable clicks on link icon
                        linkIcon.style.display = 'inline-block';
                        
                        if (pathInfo.isParent) {
                            linkIcon.title = 'Open in GitHub';
                            linkIcon.onclick = (e) => {
                                e.stopPropagation(); // Prevent triggering parent row click
                                e.preventDefault();
                            };
                        } else {
                            linkIcon.title = 'Open CSV file';
                            // For country paths, don't prevent default - let the link work normally
                        }
                        
                        pathContainer.appendChild(pathText);
                        pathContainer.appendChild(linkIcon);
                    } else {
                        pathContainer.appendChild(pathText);
                    }
                } else {
                    // For child rows: show as clickable link with shortened display path
                    pathContainer.style.pointerEvents = 'auto'; // Enable clicks for child rows
                    
                    if (pathInfo.isLink && pathInfo.path) {
                        const link = document.createElement('a');
                        link.href = pathInfo.path;
                        link.textContent = pathInfo.displayPath || pathInfo.path;
                        link.target = '_blank';
                        link.style.color = '#007bff';
                        link.style.textDecoration = 'underline';
                        pathContainer.appendChild(link);
                    } else {
                        pathContainer.textContent = pathInfo.displayPath || pathInfo.path;
                    }
                }
                
                // Add 3-dot menu for interactive files
                if (pathInfo.isLink && (pathInfo.path.endsWith('.csv') || pathInfo.path.endsWith('.json'))) {
                    const menuContainer = document.createElement('div');
                    menuContainer.className = 'data-path-menu';
                    
                    const menuTrigger = document.createElement('i');
                    menuTrigger.className = 'menu-trigger ph ph-dots-three-vertical';
                    menuTrigger.title = 'File actions';
                    
                    const dropdownMenu = document.createElement('div');
                    dropdownMenu.className = 'dropdown-menu';
                    
                    // Show/Hide Table option
                    const tableAction = document.createElement('button');
                    tableAction.className = 'dropdown-item';
                    tableAction.innerHTML = '<i class="ph ph-table"></i> Show Table';
                    tableAction.onclick = (e) => {
                        e.stopPropagation();
                        toggleDataViewer(pathDiv, pathInfo.path);
                        closeAllDropdowns();
                    };
                    
                    // View JSON/CSV option
                    const viewAction = document.createElement('a');
                    viewAction.className = 'dropdown-item';
                    viewAction.href = pathInfo.path;
                    viewAction.target = '_blank';
                    const fileExt = pathInfo.path.endsWith('.csv') ? 'CSV' : 'JSON';
                    viewAction.innerHTML = `<i class="ph ph-eye"></i> View ${fileExt}`;
                    viewAction.onclick = (e) => {
                        e.stopPropagation();
                        closeAllDropdowns();
                    };
                    
                    // Download option
                    const downloadAction = document.createElement('a');
                    downloadAction.className = 'dropdown-item';
                    downloadAction.href = pathInfo.path;
                    downloadAction.target = '_blank';
                    downloadAction.download = '';
                    downloadAction.innerHTML = `<i class="ph ph-download"></i> Download ${fileExt}`;
                    downloadAction.onclick = (e) => {
                        e.stopPropagation();
                        closeAllDropdowns();
                    };
                    
                    dropdownMenu.appendChild(tableAction);
                    dropdownMenu.appendChild(viewAction);
                    dropdownMenu.appendChild(downloadAction);
                    
                    menuContainer.appendChild(menuTrigger);
                    menuContainer.appendChild(dropdownMenu);
                    
                    // Toggle dropdown on trigger click
                    menuTrigger.onclick = (e) => {
                        e.stopPropagation();
                        closeAllDropdowns();
                        dropdownMenu.classList.toggle('show');
                    };
                    
                    pathDiv.appendChild(menuContainer);
                }
                
                // Make div clickable for expand/collapse or data viewing (limited click area)
                if (pathInfo.isParent) {
                    // True parent rows (states) - expandable with child rows
                    pathDiv.onclick = (e) => {
                        // Don't trigger if clicking on menu, links, or tabulator tables
                        if (e.target.closest('.data-path-menu') || 
                            e.target.tagName === 'A' ||
                            e.target.closest('.csv-viewer-container') ||
                            e.target.closest('.tabulator')) {
                            return;
                        }
                        
                        // Only trigger if clicking on the label or path text area
                        if (e.target.closest('.data-path-label') || 
                            e.target.classList.contains('data-path')) {
                            const arrow = pathDiv.querySelector('.expand-arrow');
                            toggleSubRows(pathInfo.stateId || pathInfo.parentId, arrow);
                        }
                    };
                } else if (pathInfo.isCountryPath) {
                    // Country paths - clickable for data viewing but styled like parent rows
                    makeDataPathClickable(pathDiv, pathInfo.path);
                } else {
                    // Child rows - normal clickable behavior
                    makeDataPathClickable(pathDiv, pathInfo.path);
                }
                
                pathDiv.appendChild(label);
                pathDiv.appendChild(pathContainer);
                pathsDiv.appendChild(pathDiv);
            });
            
            container.style.display = 'block';
        }
        
        // Update totals display
        function updateTotals(data, dataType = 'countries', totalAvailable = null) {
            const totalOutput = data.reduce((sum, row) => sum + (row.output || 0), 0);
            const totalEmployment = data.reduce((sum, row) => sum + (row.employment || 0), 0);
            const totalRegions = data.length;
            
            let regionLabel = '';
            if (dataType === 'us') {
                regionLabel = ' states';
            } else if (dataType === 'international') {
                if (totalAvailable && totalAvailable > totalRegions) {
                    regionLabel = ` of ${totalAvailable} countries available`;
                } else {
                    regionLabel = ' countries';
                }
            } else if (dataType === 'combined') {
                const stateCount = data.filter(row => row.type === 'state').length;
                const countryCount = data.filter(row => row.type === 'country').length;
                if (totalAvailable && totalAvailable > countryCount) {
                    regionLabel = ` regions (${stateCount} states + ${countryCount} of ${totalAvailable} countries available)`;
                } else {
                    regionLabel = ` regions (${stateCount} states + ${countryCount} countries)`;
                }
            }
            
            // Debug the actual values to see what's happening
            console.log('Raw totals:', { totalOutput, totalEmployment });
            console.log('Formatted output:', formatCurrency(totalOutput));
            console.log('Formatted employment:', formatEmployment(totalEmployment));
            
            // Test the formatters with known values
            console.log('Test formatCurrency(52700000000000):', formatCurrency(52700000000000)); // Should be $52.7 Trillion
            console.log('Test formatEmployment(1133000000):', formatEmployment(1133000000)); // Should be 1.133 Billion
            
            document.getElementById('totalOutput').textContent = formatCurrency(totalOutput);
            document.getElementById('totalEmployment').textContent = formatEmployment(totalEmployment);
            document.getElementById('totalRegions').textContent = totalRegions + regionLabel;
            
            document.getElementById('loadingTotals').style.display = 'none';
            document.getElementById('totalsDisplay').style.display = 'block';
        }
        
        // Create Tabulator table
        function createTable(data, dataType = 'international') {
            // Destroy existing table
            if (currentTable) {
                currentTable.destroy();
            }
            
            // Define columns based on data source
            let columns;
            
            if (dataType === 'us') {
                columns = [
                    {
                        title: "State",
                        field: "stateName",
                        width: 200,
                        formatter: function(cell) {
                            const data = cell.getRow().getData();
                            return `<a href="#state=${data.stateAbbr}" style="color: #2196f3; text-decoration: none;">${data.stateName}</a>`;
                        }
                    },
                    {
                        title: "Economic Output",
                        field: "outputFormatted",
                        width: 150,
                        sorter: function(a, b, aRow, bRow) {
                            return aRow.getData().output - bRow.getData().output;
                        }
                    },
                    {
                        title: "Employment",
                        field: "employmentFormatted", 
                        width: 120,
                        sorter: function(a, b, aRow, bRow) {
                            return aRow.getData().employment - bRow.getData().employment;
                        }
                    }
                ];
            } else if (dataType === 'international') {
                // Check if US data is included and has extended columns
                const hasUSData = data.find(row => row.country === 'US' && row.allColumns);
                
                if (hasUSData) {
                    // Create dynamic columns based on US data structure
                    columns = [
                        {
                            title: "Country",
                            field: "countryName",
                            width: 150,
                            frozen: true,
                            formatter: function(cell) {
                                const data = cell.getRow().getData();
                                return `<a href="#country=${data.country}" style="color: #2196f3; text-decoration: none;">${data.countryName}</a>`;
                            }
                        }
                    ];
                    
                    // Add columns for key metrics first
                    const keyColumns = [
                        { field: 'outputFormatted', title: 'Trade Flow Value', dataField: 'output' },
                        { field: 'employmentFormatted', title: 'Employment', dataField: 'employment' },
                        { field: 'CO2_total_formatted', title: 'CO2 Total', dataField: 'CO2_total' },
                        { field: 'Energy_total_formatted', title: 'Energy Total', dataField: 'Energy_total' },
                        { field: 'Water_total_formatted', title: 'Water Total', dataField: 'Water_total' },
                        { field: 'transactionCount', title: 'Transactions', dataField: 'transactionCount' }
                    ];
                    
                    keyColumns.forEach(col => {
                        columns.push({
                            title: col.title,
                            field: col.field,
                            width: 120,
                            sorter: function(a, b, aRow, bRow) {
                                return (aRow.getData()[col.dataField] || 0) - (bRow.getData()[col.dataField] || 0);
                            }
                        });
                    });
                    
                    // Add remaining columns from US data (excluding already added ones)
                    if (hasUSData.allColumns) {
                        const excludeColumns = ['trade_id', 'year', 'region1', 'region2', 'industry1', 'industry2', 
                                               'amount', 'Employment_total', 'CO2_total', 'Energy_total', 'Water_total'];
                        
                        hasUSData.allColumns.forEach(colName => {
                            if (!excludeColumns.includes(colName) && 
                                !columns.find(c => c.field === colName + '_formatted')) {
                                columns.push({
                                    title: colName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                                    field: colName + '_formatted',
                                    width: 100,
                                    sorter: function(a, b, aRow, bRow) {
                                        return (aRow.getData()[colName] || 0) - (bRow.getData()[colName] || 0);
                                    }
                                });
                            }
                        });
                    }
                } else {
                    // Standard international columns
                    columns = [
                        {
                            title: "Country",
                            field: "countryName",
                            width: 200,
                            formatter: function(cell) {
                                const data = cell.getRow().getData();
                                return `<a href="#country=${data.country}" style="color: #2196f3; text-decoration: none;">${data.countryName}</a>`;
                            }
                        },
                        {
                            title: "Trade Flow Value",
                            field: "outputFormatted",
                            width: 150,
                            sorter: function(a, b, aRow, bRow) {
                                return aRow.getData().output - bRow.getData().output;
                            }
                        },
                        {
                            title: "Employment Impact",
                            field: "employmentFormatted",
                            width: 150,
                            sorter: function(a, b, aRow, bRow) {
                                return aRow.getData().employment - bRow.getData().employment;
                            }
                        }
                    ];
                }
            } else if (dataType === 'combined') {
                columns = [
                    {
                        title: "Region",
                        field: "regionName",
                        width: 200,
                        formatter: function(cell) {
                            const data = cell.getRow().getData();
                            if (data.type === 'state') {
                                return `<a href="#state=${data.stateAbbr}" style="color: #2196f3; text-decoration: none;">${data.stateName}</a>`;
                            } else {
                                return `<a href="#country=${data.country}" style="color: #2196f3; text-decoration: none;">${data.countryName}</a>`;
                            }
                        }
                    },
                    {
                        title: "Type",
                        field: "type",
                        width: 80,
                        formatter: function(cell) {
                            const value = cell.getValue();
                            const color = value === 'state' ? '#1976d2' : '#388e3c';
                            return `<span style="color: ${color}; font-weight: bold; text-transform: capitalize;">${value}</span>`;
                        }
                    },
                    {
                        title: "Economic Output",
                        field: "outputFormatted",
                        width: 150,
                        sorter: function(a, b, aRow, bRow) {
                            return aRow.getData().output - bRow.getData().output;
                        }
                    },
                    {
                        title: "Employment",
                        field: "employmentFormatted",
                        width: 120,
                        sorter: function(a, b, aRow, bRow) {
                            return aRow.getData().employment - bRow.getData().employment;
                        }
                    }
                ];
                
                // Add regionName field for combined view
                data.forEach(row => {
                    row.regionName = row.type === 'state' ? row.stateName : row.countryName;
                });
            }
            
            // Create new table
            currentTable = new Tabulator("#table", {
                data: data,
                columns: columns,
                layout: "fitColumns",
                pagination: "local",
                paginationSize: 500,
                paginationSizeSelector: [10, 25, 50, 100, 500],
                movableColumns: true,
                resizableRows: true,
                initialSort: [
                    {column: "output", dir: "desc"}
                ],
                tooltips: true
            });
            
            console.log('Created table with', data.length, 'rows');
        }
        
        // Handle data source toggle
        async function handleDataSourceChange(newSource, updateHash = true) {
            if (newSource === currentDataSource && !updateHash) {
                // Allow reloading with different file selection
            } else if (newSource === currentDataSource) {
                return;
            }
            
            currentDataSource = newSource;
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('table').style.display = 'none';
            document.getElementById('loadingTotals').style.display = 'block';
            document.getElementById('totalsDisplay').style.display = 'none';
            
            // Update file selector visibility
            updateFileSelector();
            
            // Update industry filter visibility
            updateIndustryFilterVisibility();
            
            try {
                let data;
                
                if (newSource === 'us') {
                    data = await loadUSStateData();
                    if (updateHash) {
                        updateHashWithDataSource('state=all');
                    }
                } else if (newSource === 'international') {
                    data = await loadInternationalData();
                    if (updateHash) {
                        updateHashWithDataSource('country=all');
                    }
                } else if (newSource === 'combined') {
                    data = await loadCombinedData();
                    if (updateHash) {
                        updateHashWithDataSource('country=all&state=all');
                    }
                }
                
                createTable(data, newSource);
                if (newSource === 'international') {
                    // Pass availability info for international data
                    const hash = window.location.hash.substring(1);
                    const shouldIncludeUS = hash.includes('country=US') || (!hash.includes('country=') && !hash.includes('state='));
                    const totalCountries = shouldIncludeUS ? exiobaseCountries.length : exiobaseCountries.filter(c => c !== 'US').length;
                    updateTotals(data, newSource, totalCountries);
                } else if (newSource === 'combined') {
                    // Pass availability info for combined data
                    const hash = window.location.hash.substring(1);
                    const shouldIncludeUS = hash.includes('country=US') || (!hash.includes('country=') && !hash.includes('state='));
                    const totalCountries = shouldIncludeUS ? exiobaseCountries.length : exiobaseCountries.filter(c => c !== 'US').length;
                    updateTotals(data, newSource, totalCountries);
                } else {
                    updateTotals(data, newSource);
                }
                
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('table').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loadingMessage').innerHTML = '<div style="color: red;">Error loading data. Please try again.</div>';
            }
        }
        
        // Initialize the page
        async function initializePage() {
            console.log('Initializing dual-use footprint chart...');
            
            // Set up event listeners for toggle
            document.querySelectorAll('input[name="dataSource"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    console.log('Data source changed to:', this.value);
                    handleDataSourceChange(this.value);
                });
            });
            
            // Set up trade type selector change listener
            document.getElementById('tradeTypeSelector').addEventListener('change', function() {
                selectedTradeType = this.value;
                console.log('Trade type selection changed to:', selectedTradeType);
                updateDataDescription();
                updateFileOptions(); // Update available files based on trade type
                // Reload international data if currently showing international view
                if (currentDataSource === 'international' || currentDataSource === 'combined') {
                    handleDataSourceChange(currentDataSource, false);
                }
            });
            
            // Set up file selector change listener
            document.getElementById('fileSelector').addEventListener('change', function() {
                selectedDataFile = this.value;
                console.log('File selection changed to:', selectedDataFile);
                updateDataDescription();
                // Reload international data if currently showing international view
                if (currentDataSource === 'international' || currentDataSource === 'combined') {
                    handleDataSourceChange(currentDataSource, false);
                }
            });
            
            // Set up industry filter event listeners
            document.getElementById('industrycat').addEventListener('click', function() {
                const popup = document.getElementById('categoryPopup');
                popup.classList.toggle('show');
            });
            
            document.getElementById('industry').addEventListener('change', handleIndustryChange);
            
            // Close category popup when clicking outside
            document.addEventListener('click', function(event) {
                const popup = document.getElementById('categoryPopup');
                const button = document.getElementById('industrycat');
                
                if (!button.contains(event.target) && !popup.contains(event.target)) {
                    popup.classList.remove('show');
                }
            });
            
            // Load industries data
            await loadIndustriesData();
            
            // Load and apply saved filters
            loadFiltersFromCache();
            applyLoadedFilters();
            
            // Check URL hash to determine initial view
            const hash = window.location.hash.substring(1);
            let initialView = 'international'; // Default to international
            
            if (hash.includes('country=all&state=all')) {
                initialView = 'combined';
                document.querySelector('input[value="combined"]').checked = true;
            } else if (hash.includes('state=all') || hash.includes('state=')) {
                initialView = 'us';
                document.querySelector('input[value="us"]').checked = true;
            } else if (hash.includes('country=all') || hash.includes('country=')) {
                initialView = 'international';
                document.querySelector('input[value="international"]').checked = true;
            } else {
                // Default to international view when no specific hash is provided
                initialView = 'international';
                document.querySelector('input[value="international"]').checked = true;
                // Don't set the hash programmatically to avoid triggering hash change events
            }
            
            // Reset currentDataSource to force initial load
            currentDataSource = null;
            
            // Update file selector visibility for initial hash
            updateFileSelector();
            
            // Load initial data (don't update hash during initialization)
            await handleDataSourceChange(initialView, false);
            
            console.log('Page initialization complete');
        }
        
        // Handle URL hash changes for filtering
        function handleHashChange() {
            const hash = window.location.hash.substring(1);
            if (hash) {
                console.log('Hash changed:', hash);
                
                // Update year selector from hash
                const hashParams = new URLSearchParams(hash.replace(/&/g, '&').replace(/=/g, '='));
                const yearFromHash = hashParams.get('year');
                if (yearFromHash) {
                    const yearSelector = document.getElementById('yearSelector');
                    const currentYearSpan = document.getElementById('currentYear');
                    if (yearSelector && yearSelector.value !== yearFromHash) {
                        yearSelector.value = yearFromHash;
                        currentYearSpan.textContent = yearFromHash;
                        localStorage.setItem('selectedYear', yearFromHash);
                    }
                }
                
                // Update file selector visibility
                updateFileSelector();
                
                // Handle combined view (must check this first)
                if (hash.includes('country=all&state=all') || hash.includes('state=all&country=all')) {
                    if (currentDataSource !== 'combined') {
                        document.querySelector('input[value="combined"]').checked = true;
                        handleDataSourceChange('combined', false);
                    }
                }
                // Handle state view (both state=all and specific states) - check for state= without country=all
                else if (hash.includes('state=') && !hash.includes('country=all')) {
                    if (currentDataSource !== 'us') {
                        document.querySelector('input[value="us"]').checked = true;
                        handleDataSourceChange('us', false);
                    }
                    
                    // Extract state abbreviation for potential filtering
                    const stateMatch = hash.match(/state=([^&]*)/);
                    const stateParam = stateMatch ? stateMatch[1] : null;
                    console.log('State view - state param:', stateParam);
                    
                    // If we switched to different specific state(s), reload data
                    if (stateParam && stateParam !== 'all') {
                        // Handle single state or comma-separated states
                        const requestedStates = stateParam.split(',').map(s => s.trim().toUpperCase());
                        const validStates = requestedStates.filter(state => stateMapping[state]);
                        
                        if (validStates.length > 0) {
                            console.log('Loading specific states from hash change:', validStates);
                            // Force reload to show only the specific state(s)
                            usStateData = [];
                            handleDataSourceChange('us', false);
                        }
                    }
                }
                // Handle country view (both country=all and specific countries)
                else if (hash.includes('country=')) {
                    if (currentDataSource !== 'international') {
                        document.querySelector('input[value="international"]').checked = true;
                        handleDataSourceChange('international', false);
                    }
                    
                    // Extract country code for potential filtering
                    const countryMatch = hash.match(/country=([^&]*)/);
                    const countryCode = countryMatch ? countryMatch[1] : null;
                    console.log('Country view - country:', countryCode);
                    
                    // If country=US, reload international data to include US
                    if (countryCode === 'US' && currentDataSource === 'international') {
                        // Force reload to include US data
                        internationalData = [];
                        handleDataSourceChange('international', false);
                    }
                }
            }
        }
        
        // Set up hash change listener
        window.addEventListener('hashchange', handleHashChange);
        
        // Global functions for dropdown management
        function closeAllDropdowns() {
            document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                menu.classList.remove('show');
            });
        }
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', closeAllDropdowns);
        
        // Toggle sub-rows visibility
        function toggleSubRows(parentId, arrow) {
            const childRows = document.querySelectorAll(`[data-parent="${parentId}"]`);
            const isExpanded = arrow.classList.contains('expanded');
            
            childRows.forEach(row => {
                if (isExpanded) {
                    row.classList.add('hidden');
                } else {
                    row.classList.remove('hidden');
                }
            });
            
            // Toggle arrow direction
            if (isExpanded) {
                arrow.classList.remove('expanded');
            } else {
                arrow.classList.add('expanded');
            }
        }
        
        // Data Viewer Functions (handles both CSV and JSON)
        function toggleDataViewer(pathDiv, filePath) {
            const existingViewer = pathDiv.querySelector('.csv-viewer-container');
            const menuButton = pathDiv.querySelector('.dropdown-item');
            
            if (existingViewer) {
                // Toggle visibility and update button text
                const isVisible = existingViewer.style.display !== 'none';
                existingViewer.style.display = isVisible ? 'none' : 'block';
                if (menuButton) {
                    menuButton.innerHTML = isVisible ? 
                        '<i class="ph ph-table"></i> Show Table' : 
                        '<i class="ph ph-table"></i> Hide Table';
                }
                return;
            }
            
            // Create new viewer container
            const viewerContainer = document.createElement('div');
            viewerContainer.className = 'csv-viewer-container';
            
            const loadingMsg = document.createElement('div');
            const fileType = filePath.endsWith('.json') ? 'JSON' : 'CSV';
            loadingMsg.textContent = `Loading ${fileType} data...`;
            loadingMsg.style.textAlign = 'center';
            loadingMsg.style.padding = '20px';
            loadingMsg.style.fontStyle = 'italic';
            loadingMsg.style.color = '#666';
            
            viewerContainer.appendChild(loadingMsg);
            pathDiv.appendChild(viewerContainer);
            viewerContainer.style.display = 'block';
            
            // Update button text
            if (menuButton) {
                menuButton.innerHTML = '<i class="ph ph-table"></i> Hide Table';
            }
            
            // Load and display data
            if (filePath.endsWith('.json')) {
                loadJSONData(filePath, viewerContainer);
            } else {
                loadCSVData(filePath, viewerContainer);
            }
        }
        
        // Make data-path clickable for main action (limited to label/path area)
        function makeDataPathClickable(pathDiv, filePath) {
            if (filePath && (filePath.endsWith('.csv') || filePath.endsWith('.json'))) {
                pathDiv.onclick = (e) => {
                    // Don't trigger if clicking on menu, links, or tabulator tables
                    if (e.target.closest('.data-path-menu') || 
                        e.target.tagName === 'A' || 
                        e.target.closest('.csv-viewer-container') ||
                        e.target.closest('.tabulator')) {
                        return;
                    }
                    
                    // Only trigger if clicking on the label or path text area
                    if (e.target.closest('.data-path-label') || 
                        e.target.classList.contains('data-path')) {
                        toggleDataViewer(pathDiv, filePath);
                    }
                };
            }
        }
        
        async function loadCSVData(csvPath, container) {
            try {
                const response = await fetch(csvPath);
                if (!response.ok) {
                    throw new Error(`Failed to fetch CSV: ${response.status}`);
                }
                
                const csvText = await response.text();
                const csvData = parseCSVForViewer(csvText);
                
                if (csvData.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">No data found in CSV file</div>';
                    return;
                }
                
                // Create table container
                const tableContainer = document.createElement('div');
                tableContainer.className = 'csv-viewer-table';
                
                // Create unique ID for this table
                const tableId = 'csv-table-' + Date.now();
                tableContainer.id = tableId;
                
                container.innerHTML = '';
                container.appendChild(tableContainer);
                
                // Determine columns from first row
                const columns = Object.keys(csvData[0]).map(key => ({
                    title: key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                    field: key,
                    width: 120,
                    formatter: function(cell) {
                        const value = cell.getValue();
                        // Format numbers
                        if (!isNaN(value) && value !== '' && value !== null) {
                            const num = parseFloat(value);
                            if (num >= 1e9) {
                                return (num / 1e9).toFixed(2) + 'B';
                            } else if (num >= 1e6) {
                                return (num / 1e6).toFixed(2) + 'M';
                            } else if (num >= 1e3) {
                                return (num / 1e3).toFixed(2) + 'K';
                            } else if (num % 1 !== 0) {
                                return num.toFixed(3);
                            }
                        }
                        return value;
                    }
                }));
                
                // Create Tabulator table
                new Tabulator(`#${tableId}`, {
                    data: csvData,
                    columns: columns,
                    layout: "fitData",
                    pagination: "local",
                    paginationSize: 25,
                    paginationSizeSelector: [10, 25, 50, 100],
                    movableColumns: true,
                    resizableRows: true,
                    height: "300px",
                    tooltips: true,
                    headerFilterPlaceholder: "Filter...",
                    headerFilter: true
                });
                
            } catch (error) {
                console.error('Error loading CSV:', error);
                container.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc3545;">Error loading CSV: ${error.message}</div>`;
            }
        }
        
        function parseCSVForViewer(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) return [];
            
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const rows = [];
            
            for (let i = 1; i < lines.length && i < 1001; i++) { // Limit to 1000 rows for performance
                const values = lines[i].split(',');
                if (values.length >= headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] ? values[index].trim().replace(/"/g, '') : '';
                    });
                    rows.push(row);
                }
            }
            
            return rows;
        }
        
        // JSON Data Loader
        async function loadJSONData(jsonPath, container) {
            try {
                const response = await fetch(jsonPath);
                if (!response.ok) {
                    throw new Error(`Failed to fetch JSON: ${response.status}`);
                }
                
                const jsonData = await response.json();
                
                // Convert JSON to tabular format
                let tableData = [];
                
                if (Array.isArray(jsonData)) {
                    // If it's an array, use as-is
                    tableData = jsonData;
                } else if (typeof jsonData === 'object') {
                    // If it's an object, convert to array of key-value pairs
                    if (jsonData.data && Array.isArray(jsonData.data)) {
                        // Handle structured data with 'data' property
                        tableData = jsonData.data;
                    } else {
                        // Convert object properties to rows
                        tableData = Object.keys(jsonData).map(key => ({
                            key: key,
                            value: typeof jsonData[key] === 'object' ? 
                                JSON.stringify(jsonData[key]) : jsonData[key]
                        }));
                    }
                }
                
                if (tableData.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">No tabular data found in JSON file</div>';
                    return;
                }
                
                // Create table container
                const tableContainer = document.createElement('div');
                tableContainer.className = 'csv-viewer-table';
                
                // Create unique ID for this table
                const tableId = 'json-table-' + Date.now();
                tableContainer.id = tableId;
                
                container.innerHTML = '';
                container.appendChild(tableContainer);
                
                // Determine columns from first row
                const columns = Object.keys(tableData[0]).map(key => ({
                    title: key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                    field: key,
                    width: 120,
                    formatter: function(cell) {
                        const value = cell.getValue();
                        // Format numbers
                        if (!isNaN(value) && value !== '' && value !== null) {
                            const num = parseFloat(value);
                            if (num >= 1e9) {
                                return (num / 1e9).toFixed(2) + 'B';
                            } else if (num >= 1e6) {
                                return (num / 1e6).toFixed(2) + 'M';
                            } else if (num >= 1e3) {
                                return (num / 1e3).toFixed(2) + 'K';
                            } else if (num % 1 !== 0) {
                                return num.toFixed(3);
                            }
                        }
                        return value;
                    }
                }));
                
                // Create Tabulator table
                new Tabulator(`#${tableId}`, {
                    data: tableData,
                    columns: columns,
                    layout: "fitData",
                    pagination: "local",
                    paginationSize: 25,
                    paginationSizeSelector: [10, 25, 50, 100],
                    movableColumns: true,
                    resizableRows: true,
                    height: "300px",
                    tooltips: true,
                    headerFilterPlaceholder: "Filter...",
                    headerFilter: true
                });
                
            } catch (error) {
                console.error('Error loading JSON:', error);
                container.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc3545;">Error loading JSON: ${error.message}</div>`;
            }
        }
        
        // Year selector functionality
        function initializeYearSelector() {
            const yearSelector = document.getElementById('yearSelector');
            const currentYearSpan = document.getElementById('currentYear');
            
            // Load year from URL hash first, then localStorage as fallback
            const hash = window.location.hash.substring(1);
            const hashParams = new URLSearchParams(hash.replace(/&/g, '&').replace(/=/g, '='));
            const yearFromHash = hashParams.get('year');
            const savedYear = localStorage.getItem('selectedYear');
            
            const initialYear = yearFromHash || savedYear || '2022';
            
            if (yearSelector) {
                yearSelector.value = initialYear;
                currentYearSpan.textContent = initialYear;
                
                // Update hash if year came from localStorage
                if (!yearFromHash && savedYear) {
                    updateHashWithYear(savedYear);
                }
            }
            
            // Set up change listener
            if (yearSelector) {
                yearSelector.addEventListener('change', async function() {
                    const selectedYear = this.value;
                    
                    // Save to localStorage
                    localStorage.setItem('selectedYear', selectedYear);
                    
                    // Update year display in text
                    currentYearSpan.textContent = selectedYear;
                    
                    // Update URL hash with new year
                    updateHashWithYear(selectedYear);
                    
                    // Clear cached data to force reload with new year
                    usStateData = [];
                    internationalData = [];
                    combinedData = [];
                    
                    // Reload page data for new year
                    console.log('Year changed to:', selectedYear, '- reloading data...');
                    await handleDataSourceChange(currentDataSource, false);
                });
            }
        }
        
        // Helper function to update URL hash with year parameter
        function updateHashWithYear(year) {
            const hash = window.location.hash.substring(1);
            const hashParams = new URLSearchParams(hash.replace(/&/g, '&').replace(/=/g, '='));
            
            // Update or add year parameter
            hashParams.set('year', year);
            
            // Reconstruct hash
            const newHashParams = hashParams.toString();
            const newHash = newHashParams.replace(/&/g, '&').replace(/=/g, '=');
            
            // Update URL without triggering hashchange event using history.replaceState
            if (window.location.hash !== '#' + newHash) {
                history.replaceState(null, null, '#' + newHash);
            }
        }
        
        // Helper function to update URL hash with data source while preserving other parameters
        function updateHashWithDataSource(dataSourceParams) {
            const hash = window.location.hash.substring(1);
            const hashParams = new URLSearchParams(hash.replace(/&/g, '&').replace(/=/g, '='));
            
            // Parse the new data source parameters
            const newParams = new URLSearchParams(dataSourceParams.replace(/&/g, '&').replace(/=/g, '='));
            
            // Remove existing state/country parameters
            hashParams.delete('state');
            hashParams.delete('country');
            
            // Add new data source parameters
            for (const [key, value] of newParams) {
                hashParams.set(key, value);
            }
            
            // Reconstruct hash
            const newHashParams = hashParams.toString();
            const newHash = newHashParams.replace(/&/g, '&').replace(/=/g, '=');
            
            // Update URL without triggering hashchange event
            if (window.location.hash !== '#' + newHash) {
                history.replaceState(null, null, '#' + newHash);
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeYearSelector();
            initializePage();
        });
    </script>
</body>
</html>