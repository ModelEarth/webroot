<!DOCTYPE html>
<html lang="en-us">
<head>
<meta charset="utf-8">
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>Webroot</title>
<link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link type="text/css" rel="stylesheet" href="localsite/css/base.css" id="/localsite/css/base.css" />
<link type="text/css" rel="stylesheet" href="team/css/common.css" />
<script type="text/javascript" src="localsite/js/localsite.js?showheader=true&showsearch=true"></script>
<script type="text/javascript" src="team/js/common.js"></script>
<script type="text/javascript" src="team/js/setup.js"></script>

<script>
// Create OS detection panel using shared function
autoCreateOSDetectionPanel('#commonSetupDiv');

loadMarkdown("README.md", "readmeDiv", "_parent", 1, function() {
    let currentPath = window.location.href;
    let myRepo = "PartnerTools";

    const githubPagesMatch = currentPath.match(/\/\/([^.]+)\.github\.io/);
    if (githubPagesMatch && githubPagesMatch[1]) {
        myRepo = githubPagesMatch[1];
    } else if (currentPath.includes("localhost") || currentPath.includes("model.earth")) {
        myRepo = "modelearth";
    }

    let linkString = "<a href='https://github.com/" + myRepo + "/webroot/' target='github_fork'>github.com/" + myRepo + "/webroot</a>";

    setTimeout(() => {
        const textInPage = document.getElementById('textInPage');
        if (textInPage) {
            const gitAccountField = document.getElementById("gitAccount");
            const myWebrootForkNameField = document.getElementById("myWebrootForkName");
            const gitAccountValue = gitAccountField ? gitAccountField.value : '';
            const myWebrootForkNameValue = myWebrootForkNameField ? myWebrootForkNameField.value : '';

            textInPage.innerHTML = textInPage.innerHTML.replace(/the webroot repo/g, linkString);

            const newGitAccountField = document.getElementById("gitAccount");
            const newMyWebrootForkNameField = document.getElementById("myWebrootForkName");
            if (newGitAccountField && gitAccountValue) {
                newGitAccountField.value = gitAccountValue;
            }
            if (newMyWebrootForkNameField && myWebrootForkNameValue) {
                newMyWebrootForkNameField.value = myWebrootForkNameValue;
            }
        }
    }, 100);

    setTimeout(() => {
        setupWebrootSetup('webrootSetup');
        setupGitAccountFields('textInPage');
        setupQuickstartInstructions('quickstartDiv');
        createRustApiStatusPanel('combined-rust-api-container', false);
        setupTradeFlowRepos('tradeFlowRepos');
        setupGeminiResources();
        setupBackendInfo('backendInfo');
        loadMarkdown("team/admin/github/deploy-cli.md", "deployCliDiv", "_parent", 1);
        loadMarkdown("team/admin/github/deploy-git.md", "deployGitDiv", "_parent", 1);
        setTimeout(() => { updateForkReposCommands(); }, 100);
    }, 200);

    const readmeDiv = document.getElementById('readmeDiv');
    if (readmeDiv) {
        let content = readmeDiv.innerHTML;

        const currentPort = window.location.port;
        const hasExplicitPort = currentPort !== '';
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

        const currentPathname = window.location.pathname;
        const pathSegments = currentPathname.split('/').filter(segment => segment);

        let webrootFolder = '';
        if (pathSegments.length > 0 && isLocalhost) {
            if (hasExplicitPort) {
                webrootFolder = pathSegments[0];
            }
        }

        if (hasExplicitPort && currentPort !== '8887') {
            content = content.replace(/localhost:8887/g, `localhost:${currentPort}`);
            const portNotice = `<div style="background-color:#e7f3ff;border:1px solid #b3d9ff;padding:10px;margin-bottom:15px;border-radius:5px;"><strong>Your current port ${currentPort} has been used to replace 8887 in the display below.</strong></div>`;
            content = portNotice + content;
        }

        if (webrootFolder) {
            const portPattern = new RegExp(`localhost:${currentPort || '8887'}/`, 'g');
            content = content.replace(portPattern, `localhost:${currentPort || '8887'}/${webrootFolder}/`);

            setTimeout(() => {
                const webrootForkNameField = document.getElementById("myWebrootForkName");
                if (webrootForkNameField && !webrootForkNameField.value) {
                    webrootForkNameField.value = webrootFolder;
                    updateGitAccountFields();
                }
            }, 100);
        }

        readmeDiv.innerHTML = content;
    }
});

waitForElm('#showDeployGit').then(() => { // Toggle display of additional git.sh commands
    const showDeployGitBtn = document.getElementById('showDeployGit');
    const deployGitPanel = document.getElementById('deployGit');
    if (!showDeployGitBtn || !deployGitPanel) return;

    showDeployGitBtn.addEventListener('click', () => {
        const isHidden = getComputedStyle(deployGitPanel).display === 'none';
        deployGitPanel.style.display = isHidden ? 'block' : 'none';
        showDeployGitBtn.textContent = isHidden ? 'Hide Deploy Options' : 'More Deploy Options';
    });
});
</script>
</head>

<body>
<div class="content contentpadding">
    <div class="card" id="textInPage">
      <div id="webrootSetup"></div>
    </div>
    <div id="commonSetupDiv"></div>
    <div id="quickstartDiv" class="card"></div>
    <div id="combined-rust-api-container"></div>
    <div id="readmeDiv" class="card"></div>
    <div class="card" id="tradeFlowRepos"></div>
    <div class="card" id="backendInfo"></div>
    <div class="card" id="deployCliDiv"></div>
    <button id="showDeployGit" class="btn btn-success">More Deploy Options</button>
    <div id="deployGit" style="display:none">
        <div class="card" id="deployGitDiv"></div>
    </div>
</div>
</body>
</html>
