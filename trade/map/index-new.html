<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Trade Flow Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
        #map {
            height: 600px;
            width: 100%;
        }
        .arrow {
            fill: none;
            stroke-linecap: round;
            opacity: 0.6;
        }
        .checkbox-container {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            border: 1px solid #ccc;
            z-index: 1000;
        }
        .label-text {
            fill: black;
            font-size: 12px;
            font-weight: bold;
            paint-order: stroke;
            stroke: white;
            stroke-width: 2px; /* halo for readability */
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="checkbox-container" id="checkbox-container"></div>
    <script>
document.addEventListener("DOMContentLoaded", function() {
    const map = L.map('map').setView([25, 12], 3);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    const countries = {
        "USA": [-99.9018, 37.0902],
        "China": [104.1954, 35.8617],
        "Germany": [10.4515, 51.1657],
        "Brazil": [-51.9253, -14.2350],
        "India": [78.9629, 20.5937]
    };

    const trades = [
        { from: "USA", to: "China", volume: 500 },
        { from: "USA", to: "Germany", volume: 300 },
        { from: "Brazil", to: "USA", volume: 200 },
        { from: "India", to: "Germany", volume: 150 },
        { from: "China", to: "India", volume: 400 },
        { from: "Germany", to: "Brazil", volume: 100 },
        { from: "India", to: "USA", volume: 250 },
        { from: "China", to: "Germany", volume: 350 },
        { from: "Brazil", to: "China", volume: 100 },
        { from: "Germany", to: "USA", volume: 450 },
    ];

    const colorScale = d3.scaleOrdinal(d3.schemeCategory10);

    function projectPoint(lon, lat) {
        return map.latLngToLayerPoint(new L.LatLng(lat, lon));
    }

    L.svg().addTo(map);
    const svg = d3.select("#map").select("svg"),
          g = svg.append("g");

    function drawCurve(d) {
        const from = projectPoint(...countries[d.from]);
        const to = projectPoint(...countries[d.to]);
        const dx = to.x - from.x,
              dy = to.y - from.y,
              dr = Math.sqrt(dx * dx + dy * dy);

        // A consistent sweep flag to ensure arc direction.
        // You might need to adjust this for specific curve aesthetics.
        const sweepFlag = 1;

        // Ensure the path extends all the way to the 'to' point
        let targetX = to.x;
        let targetY = to.y;

        return `M${from.x},${from.y}A${dr},${dr} 0 0,${sweepFlag} ${targetX},${targetY}`;
    }

    // Draw arrows and attach text on path
    trades.forEach((trade, i) => {
        const pathId = `trade-path-${i}`;
        const markerId = `arrowhead-${i}`;

        // Arrowhead marker definition - INCREASED SIZE HERE
        svg.append("defs").append("marker")
            .attr("id", markerId)
            .attr("viewBox", "0 -5 10 10")
            .attr("refX", 10) // Still 10, as it refers to the internal viewBox coordinates
            .attr("refY", 0)
            .attr("markerWidth", 6) 
            .attr("markerHeight", 6) 
            .attr("orient", "auto")
            .append("path")
            .attr("d", "M0,-5L10,0L0,5")
            .attr("fill", colorScale(i))
            .attr("opacity", 0.6);

        // Path for the arrow (full length to destination 'to')
        g.append("path")
            .datum(trade)
            .attr("id", pathId)
            .attr("class", `arrow arrow-${trade.from}`)
            .attr("d", drawCurve(trade))
            .attr("stroke", colorScale(i))
            .attr("stroke-width", trade.volume / 50)
            .attr("marker-end", `url(#${markerId})`);

        // Attach text to follow the curve
        g.append("text")
            .append("textPath")
            .attr("xlink:href", `#${pathId}`)
            .attr("startOffset", "50%")
            .attr("class", "label-text")
            .attr("text-anchor", "middle")
            .text(trade.volume);
    });

    // Update positions on map movement
    function update() {
        g.selectAll("path.arrow").attr("d", drawCurve);
        // Text path doesn't need re-linking unless path IDs change,
        // but its position along the *newly drawn* path will be updated by startOffset.
    }

    map.on("zoomend", update);
    map.on("moveend", update);

    // Create checkboxes
    const checkboxContainer = document.getElementById('checkbox-container');
    const uniqueFromCountries = [...new Set(trades.map(trade => trade.from))];

    uniqueFromCountries.forEach(country => {
        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = true;
        checkbox.value = country;
        checkbox.addEventListener('change', function() {
            const visibility = this.checked ? 'visible' : 'hidden';
            d3.selectAll(`.arrow-${country}`).attr('visibility', visibility);
            d3.selectAll("textPath")
              .filter(function() { return this.parentNode.__data__.from === country; })
              .attr("visibility", visibility);
        });

        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(country));
        checkboxContainer.appendChild(label);
        checkboxContainer.appendChild(document.createElement('br'));
    });
});
    </script>
</body>
</html>